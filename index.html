<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Endowment Strategies & Long-Term Return Forecasts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Body background set to white */
            background-color: white;
            color: #1F2937;
        }
        .card {
            /* Card background set to light grey for subtle contrast */
            background-color: #F0F4F8;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            padding: 1.5rem;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .section-title {
            color: #003B6D;
        }
        .kpi-demographic {
            color: #D62828;
            font-weight: 900;
        }
        .kpi-endowment {
            color: #00529B;
            font-weight: 900;
        }
        .kpi-label {
            font-weight: 600;
            color: #4B5563;
        }
        .chart-container {
            position: relative;
            width: 100%;
            /* Increased max-width for better screenshotting in presentations */
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 450px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .flowchart-arrow {
            color: #70C4FF;
            font-size: 2rem;
            line-height: 1;
            /* Always point downwards */
            transform: rotate(90deg);
        }
        .flowchart-step {
            border-color: #70C4FF;
            /* Flowchart step background set to white */
            background-color: white;
            border-width: 2px;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Distribute space between content */
            width: 100%; /* Take full width on all screens */
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            width: 500px;
            position: relative;
        }
        .modal-close-button {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4A5568;
        }
        .calculator-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00529B;
            cursor: pointer;
        }
        .calculator-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00529B;
            cursor: pointer;
        }
        .asset-input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }
        .asset-input-group label {
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .asset-input-group .value-display {
            font-weight: bold;
            color: #00529B;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            margin-right: 1.5rem;
            cursor: pointer;
            font-weight: 500;
            color: #374151;
        }
        .radio-group input[type="radio"] {
            margin-right: 0.5rem;
            accent-color: #00529B;
        }
        /* Reverted presentation slide styles */
        .presentation-section { /* Renamed from .presentation-slide */
            margin-bottom: 3rem; /* Space between sections */
            /* Presentation section background set to light grey */
            background-color: #F0F4F8;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
        }
        .presentation-section h2 {
            font-size: 2.5rem;
            font-weight: bold;
            color: #003B6D;
            margin-bottom: 1.5rem;
            text-align: center; /* Ensure titles are centered */
        }
        .presentation-section p {
            font-size: 1.25rem;
            color: #374151;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 1rem;
            text-align: center; /* Ensure paragraphs are centered */
        }

    </style>
</head>
<body class="antialiased">

    <header class="bg-white shadow-md p-6 text-center sticky top-0 z-50">
        <div class="flex justify-center items-center max-w-7xl mx-auto">
            <div class="flex-grow text-center">
                <h1 class="text-3xl md:text-4xl font-extrabold section-title">Endowment Strategies & Long-Term Return Forecasts</h1>
                <p class="text-md text-gray-600 mt-2 max-w-4xl mx-auto">Navigating demographic shifts and capital market evolution with strategic endowment management and data-driven forecasts.</p>
            </div>
        </div>
    </header>

    <main class="p-4 md:p-8 max-w-6xl mx-auto"> <section class="presentation-section">
            <h2>The Imperative for Change</h2>
            <p>Futureproofing our institution demands a candid assessment: the returns we've grown accustomed to will fall short. The looming demographic cliff directly translates to increased student acquisition challenges, demanding enhanced endowment growth to compensate, precisely when many traditional investment returns are projected to diminish.</p>
        </section>

        <section class="presentation-section">
            <h2>Demographic Cliff: U.S. High School Graduate Projections</h2>
            <p>U.S. high school graduations are projected to peak this year with 3.9M students, followed by a sustained decline in population reaching 3.4M by 2041. This necessitates strategic adjustments for higher education institutions. Regional projections tell a similar story.</p>
            <div class="card p-6 md:p-8 w-full">
                <h3 class="text-2xl font-bold text-center section-title mb-4">Ohio Graduation Trends</h3>
                <p class="text-center text-gray-700 max-w-4xl mx-auto mb-8">This chart illustrates Ohio's projected high school graduate trends, reflecting a regional example of the national 2025 peak and subsequent decline.</p>
                <div class="chart-container">
                    <canvas id="nationalDeclineChart"></canvas>
                </div>
                <a href="https://www.wiche.edu/knocking/data-visualizations/geography/" target="_blank" class="text-blue-600 hover:underline">source</a>
            </div>
        </section>

        <section class="presentation-section">
            <h2 class="section-title mb-8">Regional Impact: Ohio & Neighboring States</h2>
            <p>The demographic cliff's impact varies regionally. Ohio is projected to fare better than some neighboring states in terms of high school graduate decline through 2041; however, this relative advantage does not imply immunity from increasing enrollment competition, underscoring the need for robust financial planning and endowment growth.</p>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-stretch w-full">
                <div class="card p-6 md:p-8 flex flex-col">
                    <div>
                        <h3 class="text-2xl font-bold section-title mb-4">Projected Decline in HS Grads (2023-2041) by State</h3>
                        <p class="text-center text-gray-700 mb-6">Decline varies significantly; West Virginia and Michigan face the steepest drops, impacting tuition-dependent private colleges most severely.</p>
                    </div>
                    <div class="chart-container mt-auto">
                        <canvas id="regionalDeclineChart"></canvas>
                    </div>
                    <div class="text-center mt-4">
                        <a href="https://www.wiche.edu/knocking/data-visualizations/geography/" target="_blank" class="text-xs text-blue-600 hover:underline">source</a>
                    </div>
                </div>
                <div class="card p-6 md:p-8 flex flex-col">
                    <div>
                        <h3 class="text-2xl font-bold section-title mb-4 text-center">Ohio College Enrollment</h3>
                        <p class="text-center text-gray-700 mb-4">Compounding the graduation decline, Ohio's total college enrollment dropped to 612,352 in 2020, a 17.8% decrease from 2010 levels.</p>
                    </div>
                    <div class="chart-container mt-auto" style="height: 200px; max-height: 200px;">
                        <canvas id="ohioEnrollmentChart"></canvas>
                    </div>
                    <div class="text-center mt-4">
                        <a href="https://www.wiche.edu/knocking/data-visualizations/geography/" target="_blank" class="text-xs text-blue-600 hover:underline">source</a>
                    </div>
                </div>
            </div>
        </section>

        <section class="presentation-section">
            <h2>Shifting Macroeconomic Environment: Fundamental Changes</h2>
            <p>Our investment decisions must now factor in profound, interconnected macroeconomic shifts. The "worldview concept" guiding past investment strategies is fundamentally changing.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full">
                <div class="card p-6">
                    <h3 class="text-2xl font-bold section-title mb-4">Technological Transformation (AI)</h3>
                    <p class="text-gray-700">AI adoption is expected to boost economic growth and counterbalance the workforce declines from the retiring baby boomer generation in the U.S.</p>
                </div>
                <div class="card p-6">
                    <h3 class="text-2xl font-bold section-title mb-4">Geopolitical Restructuring & Energy Transition</h3>
                    <p class="text-gray-700">Rising global energy demand, energy independence goals, and geopolitical tensions are reshaping supply chains and trade (e.g., U.S.-China relations).</p>
                </div>
                <div class="card p-6">
                    <h3 class="text-2xl font-bold section-title mb-4">Evolving Policy & Regulatory Paradigms</h3>
                    <p class="text-gray-700">Expect declining short-term interest rates and modest yield-curve steepening. Deregulation, increased retail exposure to private markets, and tax reform discussions are ongoing.</p>
                </div>
            </div>
        </section>

        <section class="presentation-section">
            <h2>The Bond Market: A Critical Indicator</h2>
            <p>The bond market is a primary indicator of expected inflation and future economic conditions. With federal debt and M2 money supply significantly elevated, and rising interest expenses, the traditional role of bonds in a portfolio needs re-evaluation.</p>
            <div class="flex justify-center w-full">
                <div class="card p-6 md:w-3/4">
                    <h3 class="text-2xl font-bold section-title mb-4">Federal Debt & Debt-to-GDP</h3>
                    <p class="text-gray-700 mb-4">Federal debt is approximately $37 trillion, with a Debt-to-GDP ratio around 120%. These figures are projected to continue rising, posing significant questions for long-term fiscal stability and inflation.</p>
                    <div class="chart-container">
                        <canvas id="federalDebtToGDPChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section class="presentation-section">
            <h2>Inflation Erosion & Portfolio Returns</h2>
            <p>While equities offer long-term return potential, public market participation alone may not suffice to outpace inflation. M2 money supply expansion correlates with nominal asset price gains (NASDAQ), yet fuels systemic inflationary pressures, diminishing real returns. Endowments should consider diversified alpha sources and inflation-protected allocations beyond traditional market returns.</p>
            <div class="card p-6 md:p-8 w-full">
                <h3 class="text-2xl font-bold text-center section-title mb-4">NASDAQ vs. M2 Money Stock</h3>
                <div class="flex justify-center items-center w-full">
                    <img src="https://fred.stlouisfed.org/graph/fredgraph.png?g=1JLoG" alt="NASDAQ vs. M2 Money Stock" class="w-full h-auto block mx-auto">
                </div>
            </div>
        </section>

        <section class="presentation-section">
            <h2>Are We Keeping Pace? Defining "Our" Inflation</h2>
            <p>Our endowment's primary goal is to preserve and grow purchasing power to support the institution's mission. This requires us to measure inflation not just by broad consumer price indices (CPI, PCE), but also by asset inflation and our specific spending needs (HEPI).</p>
            <p>The M2 money supply growth rate can serve as a relevant hurdle rate for our principal growth to truly maintain purchasing power.</p>
            <div class="chart-container">
                <canvas id="inflationChart"></canvas>
            </div>
            <p class="text-sm text-gray-600 mt-4">
                <strong class="text-blue-700">Note:</strong> Inflation data is illustrative, based on historical averages/forecasts. Our projected portfolio return must consistently exceed these benchmarks.
            </p>
        </section>

        <section class="presentation-section">
            <h2>What this means for asset classes</h2>
            <p class="text-left">
                <strong class="section-title">Bonds:</strong> While nominally safe, their real value is eroded over time. Yields are often below inflation, leading to a guaranteed loss of purchasing power.
            </p>
            <p class="text-left">
                <strong class="section-title">Equities & Real Assets:</strong> Provide crucial exposure to the real, productive economy. These have historically outperformed during inflationary regimes, helping to preserve wealth.
            </p>
            <p class="text-left">
                <strong class="section-title">Alternative & Private Markets:</strong> These sophisticated strategies and less traditional assets have consistently demonstrated a lead in generating strong returns.
            </p>
        </section>
        
        <section class="presentation-section">
            <h2>Portfolio Return Projection & Scenario Analysis</h2>
            <p>We can model long-term nominal returns based on chosen Capital Market Assumptions and asset allocations to understand potential outcomes.</p>
            <div class="card p-6 md:p-8 w-full">
                <h3 class="text-2xl font-bold text-center section-title mb-2">Model Your Allocation Here</h3>
                <p class="text-center text-lg text-gray-700 mb-8">Model long-term nominal returns based on chosen Capital Market Assumptions and asset allocations.</p>

                <div class="mb-6">
                    <label for="sourceSelect" class="block text-xl font-bold section-title mb-2">Select Source(s):</label>
                    <div id="sourceCheckboxes" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-y-2 gap-x-4">
                    </div>
                </div>

                <details id="assetSelectionDetails" class="mb-6 border rounded-lg shadow-sm">
                    <summary class="p-4 cursor-pointer font-bold text-lg bg-gray-50 rounded-t-lg flex justify-between items-center">
                        Manage Asset Classes (Based on selected sources)
                        <span class="text-gray-500">▼</span>
                    </summary>
                    <div id="assetSelectionCheckboxes" class="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-y-2 gap-x-4">
                    </div>
                </details>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6">
                    <div id="calculator-inputs">
                    </div>

                    <div class="flex flex-col items-center justify-center bg-gray-50 rounded-lg p-6">
                        <p id="totalAllocation" class="text-lg font-bold text-green-600 mb-4">Total Allocation: 0%</p>
                        <div class="text-center mb-6">
                            <p class="text-lg font-semibold text-gray-700">Projected 10+ Year Nominal Return</p>
                            <p id="projectedReturn10Plus" class="text-5xl font-extrabold kpi-endowment">0.0%</p>
                        </div>
                        <div class="chart-container h-60 mt-6">
                            <canvas id="allocationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="endowment-landscape" class="presentation-section">
            <h2 class="section-title mb-2">Investment Landscape: Future Return Realities</h2>
            <p class="text-lg text-gray-700 mb-8">Northern Trust's 2025 Capital Market Assumptions indicate shifts driven by AI, energy transition, and globalization. Elevated U.S. equity valuations may moderate future gains; private markets show greater potential. A strategic, globally diversified approach is essential for endowment growth against demographic pressures.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full">
                <div class="card p-6">
                    <h3 class="text-2xl font-bold section-title mb-4 text-center">Asset Allocation by Endowment Size</h3>
                    <p class="text-center text-gray-700 mb-6">Larger endowments typically increase alternative allocations. Smaller institutions should consider mirroring this for higher returns.</p>
                    <div class="chart-container">
                        <canvas id="allocationBySizeChart"></canvas>
                    </div>
                </div>
                <div class="card p-6">
                    <h3 class="text-2xl font-bold section-title mb-4 text-center">Northern Trust 10-Year Expected Nominal Returns (2025)</h3>
                    <p class="text-center text-gray-700 mb-6">Northern Trust forecasts strong potential in private equity, international equities, and real assets, underscoring diversification for target returns.</p>
                    <div class="chart-container">
                        <canvas id="expectedReturnsChart"></canvas>
                    </div>
                </div>
            </div>
             <div class="mt-8 text-center text-gray-700">
                <h3 class="text-2xl font-bold section-title mb-4">Strategic Importance: Diversification for Resilience</h3>
                <p class="max-w-4xl mx-auto">Concentration in U.S. public markets is less advisable due to high valuations and new market dynamics. Northern Trust's analysis advocates global diversification, shifting to international equities, private markets (equity, credit), and real assets to capture higher expected returns and enhance resilience.</p>
            </div>
        </section>

        <!-- Addressing Bitcoin Concerns Section Start -->
        <section class="presentation-section">
            <h2 class="section-title mb-4 text-center">Addressing Bitcoin Concerns: Volatility & Risk</h2>
            <p class="text-lg text-gray-700 mb-8 text-center max-w-4xl mx-auto">
                For many institutional investors, Bitcoin's primary concern has been its historical annualized volatility. While undeniably a volatile asset, recent trends suggest a maturation process. It's also crucial to contextualize this volatility; analysis from Fidelity Digital Assets, using 90-day realized volatility, showed that in October 2023, Bitcoin was less volatile than 92 of the S&P 500 stocks. This can also be compared to historical precedents, such as gold during its initial integration into the modern financial system.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-5xl mx-auto">
                <!-- Card 1: Bitcoin Volatility -->
                <div class="card p-6 flex flex-col items-center">
                    <h3 class="text-xl font-bold section-title mb-4 text-center">Declining Volatility Trend</h3>
                    <img src="https://fwc.widen.net/content/0gxab3wf3d/jpeg/5%20-%20Bitcoin%20Realized%20Volatility.jpeg?w=640&keep=c&crop=yes&color=cccccc&quality=100&u=5lvvtn" alt="Bitcoin Realized Volatility" class="w-full h-auto rounded-lg shadow-md mb-4">
                    <p class="text-gray-700 text-center">Bitcoin's 90-day realized volatility has shown a notable downward trend, indicating a potential shift towards greater price stability as the asset class matures.</p>
                </div>
                <!-- Card 2: Gold Volatility -->
                <div class="card p-6 flex flex-col items-center">
                     <h3 class="text-xl font-bold section-title mb-4 text-center">A Historical Parallel: Gold</h3>
                    <img src="https://fwc.widen.net/content/nvlnlqlenp/jpeg/6%20-%20Gold%20Price%20and%20Historical%20Volatility.jpeg?w=640&keep=c&crop=yes&color=cccccc&quality=100&u=5lvvtn" alt="Gold Price and Historical Volatility" class="w-full h-auto rounded-lg shadow-md mb-4">
                    <p class="text-gray-700 text-center">Gold experienced significant volatility after the breakdown of the Bretton Woods system in the 1970s, a pattern that mirrors Bitcoin's early years as a new store of value.</p>
                </div>
                <!-- Card 3: Risk in Context -->
                <div class="card p-6 flex flex-col items-center">
                     <h3 class="text-xl font-bold section-title mb-4 text-center">Risk in Context</h3>
                    <img src="https://fwc.widen.net/content/um3l0lghfo/jpeg/3%20-%20Maginificent%20Seven.jpeg?w=640&keep=c&crop=yes&color=cccccc&quality=100&u=5lvvtn" alt="Bitcoin vs Magnificent Seven Stocks Risk" class="w-full h-auto rounded-lg shadow-md mb-4">
                    <p class="text-gray-700 text-center">When viewed alongside the "Magnificent Seven" tech stocks, Bitcoin's risk profile, while high, is within the range of other growth-oriented assets familiar to modern portfolios.</p>
                </div>
                 <!-- Card 4: Sharpe vs. Sortino Ratio -->
                <div class="card p-6 flex flex-col">
                    <h3 class="text-xl font-bold section-title mb-4 text-center">Sharpe vs. Sortino: A Better View of Risk</h3>
                    <div class="flex-grow">
                        <p class="text-gray-700 text-center mb-4">
                            The <strong>Sharpe ratio</strong> measures return against total volatility (both upside and downside). For an asset like Bitcoin, with significant upside potential, this can be misleading as it penalizes positive price swings.
                        </p>
                        <p class="text-gray-700 text-center mb-6">
                            The <strong>Sortino ratio</strong>, however, only considers downside volatility. This provides a more favorable and arguably more relevant measure of risk-adjusted return for assets with asymmetric return profiles, as it doesn't punish the "good" volatility that investors seek.
                        </p>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg w-full mt-auto">
                        <h4 id="ratiosPeriodTitle" class="text-lg font-bold text-center section-title mb-3">Calculated Ratios</h4>
                        <div class="flex justify-around text-center">
                            <div>
                                <p class="text-xs font-semibold text-gray-500 uppercase">SHARPE RATIO</p>
                                <p id="sharpeRatio" class="text-2xl font-bold text-gray-800">--</p>
                            </div>
                            <div>
                                <p class="text-xs font-semibold text-gray-500 uppercase">SORTINO RATIO</p>
                                <p id="sortinoRatio" class="text-2xl font-bold text-blue-600">--</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
             <p class="text-xs text-gray-500 mt-6 text-center">
                Volatility analysis based on data from <a href="https://www.fidelitydigitalassets.com/research-and-insights/closer-look-bitcoins-volatility" target="_blank" class="text-blue-600 hover:underline">Fidelity Digital Assets</a>, using data from Glassnode.
            </p>
        </section>
        <!-- Addressing Bitcoin Concerns Section End -->

        <!-- MODIFIED BITCOIN SECTION START -->
        <section class="presentation-section">
            <h2>Bitcoin Price History</h2>
            <p>Explore the historical price of Bitcoin. Use the sliders to select the investment duration and move the analysis window through Bitcoin's history.</p>
            <div class="card p-6 md:p-8 w-full">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 items-center">
                    <div class="md:col-span-2 space-y-4">
                        <div>
                            <label for="btcTimeHorizonSlider" class="block text-sm font-medium text-gray-700 mb-1">Select Time Horizon: <span id="btcTimeHorizonDisplay" class="font-bold">48 months (4.0 years)</span></label>
                            <input type="range" id="btcTimeHorizonSlider" min="1" max="120" value="48" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer calculator-slider">
                        </div>
                        <div>
                            <label for="btcRangeSlider" class="block text-sm font-medium text-gray-700 mb-1">Adjust Time Window Start Date</label>
                            <input type="range" id="btcRangeSlider" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer calculator-slider">
                            <div id="btcDateRangeDisplay" class="text-sm text-gray-500 mt-2 text-center font-medium"></div>
                        </div>
                    </div>
                    <div class="text-center md:text-left bg-gray-100 p-4 rounded-lg space-y-2">
                        <div>
                            <p class="text-xs font-semibold text-gray-500 uppercase">Start Price</p>
                            <p id="btcStartPrice" class="text-lg font-bold text-gray-800">$0.00</p>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-gray-500 uppercase">End Price</p>
                            <p id="btcEndPrice" class="text-lg font-bold text-gray-800">$0.00</p>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-gray-500 uppercase">Total Return</p>
                            <p id="btcTotalReturn" class="text-2xl font-bold text-gray-800">+0.00%</p>
                        </div>
                    </div>
                </div>
                <div class="chart-container" style="height: 450px;">
                    <canvas id="bitcoinChart"></canvas>
                </div>
            </div>
        </section>
        <!-- MODIFIED BITCOIN SECTION END -->

        <!-- Institutional Adoption Section Start -->
        <section class="presentation-section">
            <h2 class="section-title mb-4 text-center">Institutional Bitcoin Adoption: A New Frontier</h2>
            <p class="text-lg text-gray-700 mb-8 text-center max-w-4xl mx-auto">Leading academic and financial institutions are beginning to allocate portions of their endowments and funds into Bitcoin ETFs, signaling a landmark shift in institutional investment strategy.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full mb-8">
                <!-- Card 1: Brown University -->
                <div class="card p-6 flex flex-col">
                    <h3 class="text-2xl font-bold section-title mb-4">Brown University's Strategic Move</h3>
                    <p class="text-gray-700 flex-grow">Citing Q1 2024 SEC filings, Brown University's ~$7 billion endowment disclosed a multi-million dollar investment in Bitcoin ETFs. Reports confirm holdings of over $7 million in BlackRock's IBIT and Grayscale's GBTC, marking a calculated entry into digital assets by a prominent Ivy League institution.</p>
                    <p class="text-xs text-gray-500 mt-4">Source: 13F Filings, CoinDesk</p>
                </div>

                <!-- Card 2: BlackRock & Fidelity -->
                <div class="card p-6 flex flex-col">
                    <h3 class="text-2xl font-bold section-title mb-4">Titans of Finance: BlackRock & Fidelity</h3>
                    <p class="text-gray-700 flex-grow">The launch of spot Bitcoin ETFs by giants like BlackRock (IBIT) and Fidelity (FBTC) has been monumental. These products shattered records for asset inflows, providing regulated, low-barrier access to Bitcoin. This innovation has legitimized digital assets for a broader range of investors and integrated them into mainstream finance.</p>
                </div>
            </div>
             <!-- Card 3: Wall Street Legends -->
            <div class="card p-8 w-full">
                 <h3 class="text-2xl font-bold section-title mb-6 text-center">Wall Street Perspectives</h3>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <blockquote class="border-l-4 border-blue-500 pl-4">
                        <p class="italic text-gray-700">"Bitcoin has this enormous contingency of really, really smart and sophisticated people who believe in it... It’s like investing with Steve Jobs and Apple or investing in Google early."</p>
                        <footer class="text-right font-semibold mt-2">- Paul Tudor Jones</footer>
                    </blockquote>
                    <blockquote class="border-l-4 border-blue-500 pl-4">
                        <p class="italic text-gray-700">"If the gold bet works, the bitcoin bet will probably work better because it’s thinner, more illiquid and has a lot more beta to it."</p>
                        <footer class="text-right font-semibold mt-2">- Stanley Druckenmiller</footer>
                    </blockquote>
                     <blockquote class="border-l-4 border-blue-500 pl-4">
                        <p class="italic text-gray-700">"Bitcoin’s a lot less risky at $43,000 than it was at $300. It’s now established, huge amounts of venture-capital money have gone into it."</p>
                        <footer class="text-right font-semibold mt-2">- Bill Miller</footer>
                    </blockquote>
                 </div>
            </div>
        </section>
        <!-- Institutional Adoption Section End -->

        </main>

    <footer class="text-center p-6 mt-12 bg-gray-800 text-white">
        <p>Infographic synthesizes data for strategic planning.</p>
        <p class="text-sm text-gray-400 mt-2">Demographic data: WICHE. Financial forecasts: Northern Trust Capital Market Assumptions 10-Year Outlook: 2025 Edition (Jan 2025), with supplementary data from Spring 2025 outlooks.</p>
    </footer>

    <script>
        Chart.register(ChartZoom);

        // Custom plugin to draw text in the center of a doughnut chart
        const doughnutTextPlugin = {
            id: 'doughnutText',
            afterDraw(chart, args, options) {
                if (chart.config.type !== 'doughnut' || !options.text) {
                    return;
                }
                const { ctx, chartArea: { top, right, bottom, left, width, height } } = chart;
                ctx.save();
                
                const text = options.text;
                const subtext = options.subtext || '';
                const textY = (height / 2) + top;

                // Main text
                ctx.font = options.font || 'bold 3rem Inter';
                ctx.fillStyle = options.color || '#D62828';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(text, width / 2, textY - 10); // Adjust Y position slightly up

                // Subtext
                if (subtext) {
                    ctx.font = options.subtextFont || '1rem Inter';
                    ctx.fillStyle = options.subtextColor || '#4B5563';
                    ctx.fillText(subtext, width / 2, textY + 20); // Adjust Y position down
                }
                ctx.restore();
            }
        };
        Chart.register(doughnutTextPlugin);


        const chartColors = {
            blue1: '#003B6D',
            blue2: '#00529B',
            blue3: '#70C4FF',
            accentGold: '#FFBC42',
            accentRed: '#D62828',
            gray: '#E5E7EB',
            green: '#28A745',
            purple: '#6610f2',
            darkBlue: '#0A2540', /* Added for more distinction */
            lightGreen: '#66bb6a', /* Added for more distinction */
            orange: '#ff9800' /* Added for more distinction */
        };

        const FONT_COLOR = '#1F2937';
        Chart.defaults.color = FONT_COLOR;
        Chart.defaults.font.family = "'Inter', sans-serif";

        const wrapLabel = (label, maxWidth = 16) => {
            if (typeof label !== 'string') return label;
            const words = label.split(' ');
            let lines = [];
            let currentLine = '';
            words.forEach(word => {
                if ((currentLine + ' ' + word).trim().length > maxWidth && currentLine !== '') {
                    lines.push(currentLine.trim());
                    currentLine = word;
                } else {
                    currentLine = (currentLine + ' ' + word).trim();
                }
            });
            if (currentLine) lines.push(currentLine.trim());
            return lines;
        };

        const tooltipTitleCallback = (tooltipItems) => {
            const item = tooltipItems[0];
            let label = item.chart.data.labels[item.dataIndex];
            if (Array.isArray(label)) return label.join(' ');
            return label;
        };

        const commonPlugins = {
            legend: {
                position: 'bottom',
                labels: { color: FONT_COLOR, font: { weight: '600' } }
            },
            tooltip: {
                enabled: true,
                mode: 'index',
                intersect: false,
                callbacks: { title: tooltipTitleCallback },
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleFont: { size: 14, weight: 'bold' },
                bodyFont: { size: 12 },
            }
        };

        const defaultChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: commonPlugins,
            scales: {
                y: { beginAtZero: false, grid: { color: '#E0E0E0' }, ticks: { font: { size: 12 } } },
                x: { grid: { display: false }, ticks: { font: { size: 12 } } }
            },
            backgroundColor: 'white' // Explicitly set chart background to white
        };

        new Chart(document.getElementById('nationalDeclineChart'), {//Ohio, not national
            type: 'line',
            data: {
                labels: ['2025', '2027', '2029', '2031', '2033', '2035', '2037', '2039', '2041'],
                datasets: [{
                    label: 'Projected HS Graduates',
                    data: [143303, 140034, 136317, 135396, 131197, 134895, 131405, 127684, 124461],
                    borderColor: chartColors.accentRed,
                    backgroundColor: 'rgba(214, 40, 40, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: { ...defaultChartOptions, scales: { y: { ...defaultChartOptions.scales.y, title: { display: true, text: 'Number of Graduates' } } } }
        });

        const regionalData = [
            { state: 'Ohio', decline: -6 },
            { state: 'Kentucky', decline: -9 },
            { state: 'Indiana', decline: -10 },
            { state: 'Pennsylvania', decline: -17 },
            { state: 'Michigan', decline: -20 },
            { state: 'West Virginia', decline: -26 },
        ].sort((a, b) => a.decline - b.decline);

        new Chart(document.getElementById('regionalDeclineChart'), {
            type: 'bar',
            data: {
                labels: regionalData.map(d => wrapLabel(d.state, 12)),
                datasets: [{
                    label: 'Projected % Change in HS Grads (2023-2041)',
                    data: regionalData.map(d => d.decline),
                    backgroundColor: chartColors.blue2,
                    borderColor: chartColors.blue1,
                    borderWidth: 1
                }]
            },
            options: { ...defaultChartOptions, indexAxis: 'y', scales: { x: { title: { display: true, text: 'Percent Change (%)' } } } }
        });

        // New Ohio Enrollment Chart
        new Chart(document.getElementById('ohioEnrollmentChart'), {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [17.8, 100 - 17.8],
                    backgroundColor: [chartColors.accentRed, chartColors.gray],
                    borderColor: '#F0F4F8',
                    borderWidth: 4,
                    circumference: 180, // Make it a semi-circle
                    rotation: -90      // Start at the top
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: false
                    },
                    doughnutText: {
                        text: '-17.8%',
                        subtext: 'Decline 2010-2020',
                        color: chartColors.accentRed,
                        font: 'bold 2rem Inter',
                        subtextColor: '#4B5563',
                        subtextFont: '0.9rem Inter'
                    }
                }
            }
        });

        new Chart(document.getElementById('allocationBySizeChart'), {
            type: 'bar',
            data: {
                labels: ['Under $25M', '$25M to $50M', '$50M to $100M', '$100M to $500M', '$500M to $1B', 'Over $1B'],
                datasets: [
                    { label: 'Cash', data: [7, 7, 6, 6, 7, 4], backgroundColor: chartColors.blue1 }, // Use blue1 for cash
                    { label: 'Fixed Income', data: [24, 20, 17, 13, 9, 7], backgroundColor: chartColors.blue2 }, // Use blue2 for fixed income
                    { label: 'U.S. Equities', data: [42, 37, 33, 27, 20, 13], backgroundColor: chartColors.accentGold }, // Use accentGold for US Equities
                    { label: 'Non-U.S. Equities', data: [16, 19, 22, 22, 22, 19], backgroundColor: chartColors.blue3 }, // Use blue3 for Non-US Equities
                    { label: 'Alternatives', data: [11, 17, 22, 32, 42, 57], backgroundColor: chartColors.accentRed }, // Use accentRed for Alternatives
                ]
            },
            options: { ...defaultChartOptions, scales: { x: { stacked: true }, y: { stacked: true, title: { display: true, text: 'Allocation (%)' } } } }
        });

        const ntExpectedReturnsDataRaw = {
            labels: [
                wrapLabel('U.S. Inflation Linked (TIPS)'),
                wrapLabel('U.S. Aggregate Fixed Income'),
                wrapLabel('Hedge Funds'),
                wrapLabel('Listed Real Estate'),
                wrapLabel('Emerging Markets Equities'),
                wrapLabel('Global Equities'),
                wrapLabel('U.S. Equities'),
                wrapLabel('Private Real Estate'),
                wrapLabel('Private Credit'),
                wrapLabel('Opportunistic Private Credit'),
                wrapLabel('Private Equity')
            ],
            returns: [4.0, 4.7, 5.5, 6.3, 6.4, 7.1, 7.5, 7.3, 8.4, 12.2, 10.1]
        };
        
        const combinedData = ntExpectedReturnsDataRaw.labels.map((label, index) => {
            return {
                label: label,
                return: ntExpectedReturnsDataRaw.returns[index]
            };
        });

        combinedData.sort((a, b) => a.return - b.return);

        const sortedLabels = combinedData.map(item => item.label);
        const sortedReturns = combinedData.map(item => item.return);

        new Chart(document.getElementById('expectedReturnsChart'), {
            type: 'bar',
            data: {
                labels: sortedLabels,
                datasets: [{
                    label: 'Northern Trust 10-Year Nominal Return (%)',
                    data: sortedReturns,
                    backgroundColor: chartColors.blue1
                }]
            },
            options: {
                ...defaultChartOptions,
                indexAxis: 'y',
                plugins: {
                    ...defaultChartOptions.plugins,
                    tooltip: {
                        ...defaultChartOptions.plugins.tooltip,
                        mode: 'y', // Correct interaction mode for horizontal bars
                    },
                    zoom: { // Disable zoom and pan for this chart
                        pan: { enabled: false },
                        zoom: {
                            drag: { enabled: false },
                            wheel: { enabled: false },
                            pinch: { enabled: false }
                        }
                    }
                },
                scales: {
                    ...defaultChartOptions.scales,
                    x: {
                        ...defaultChartOptions.scales.x,
                        title: { display: true, text: 'Annualized Nominal Return (%)' }
                    }
                }
            }
        });

        const allAssetReturns = {
            "Northern Trust": {
                "US Large Cap Equities":    7.5,
                "US Small Cap Equities":    9.6,
                "Developed International Equities (General)":   7.1,
                "Emerging Market Equities": 6.4,
                "Global Equities (ACWI)":7.1,
                "Global Developed Equities":    7.1,
                "US Investment Grade Bonds":    4.7,
                "US High Yield Bonds":  5.6,
                "US TIPS":  4.0,
                "Cash Equivalents / US Cash":   3.3,
                "Real Estate (REITs)":  6.3,
                "Commodities":  6.2,
                "Private Equity":   10.1,
                "Private Debt / Private Credit":    8.4,
                "Hedge Funds":  5.5,
                "Global Investment Grade Bonds":    3.6,
                "Global High Yield Bonds":  5.9,
                "Global Natural Resources": 6.2,
                "Global Listed Infrastructure": 6.6,
                "Australian Equities":  8.2,
                "Canadian Equities":    5.3,
                "Europe Equities":  5.2,
                "UK Equities":  4.4,
                "Japan Equities":   6.0,
                "Canadian Bonds (Aggregate/Universe)":  3.6,
                "Euro Government Bonds":    3.1,
                "Euro Corporate Bonds": 3.1,
                "Australian Government Bonds":  4.5,
                "Japanese Government Bonds":    1.4,
                "Japanese Corporate Bonds": 1.9,
                "UK Government Bonds":  4.9,
                "Venture Capital":  11.6,
                "Buyout":   9.5,
                "Growth (Private Equity)":  11.0,
                "Inflation Linked (Canada)":    2.5,
                "Inflation Linked (Euro)":  3.0,
                "Inflation Linked (UK)":    3.2,
                "Inflation Linked (Japan)": 1.5,
                "Inflation Linked (Australia)": 4.2,
                "Inflation Linked (Global)":    3.3,
                "Municipal Bonds":  4.0,
                "HF-Equity Hedge":  5.4,
                "HF-Relative Value":    5.6,
                "HF-Macro": 6.0,
                "HF-Event Driven":  5.1
            },
            "Janney Montgomery Scott": {
                "US Large Cap Equities":    7.0,
                "US Small Cap Equities":    8.5,
                "Developed International Equities (General)":   8.0,
                "Emerging Market Equities": 8.5,
                "US Investment Grade Bonds":    5.25,
                "US High Yield Bonds":  6.5,
                "Cash Equivalents / US Cash":   3.2,
                "Real Estate (REITs)":  7.0,
                "Commodities":  5.0,
                "Private Equity":   9.0,
                "Private Debt / Private Credit":    6.75

            },
            "State Street Global Advisors": {
                "US Large Cap Equities":    6.1,
                "US Small Cap Equities":6.6,
                "US Mid Cap Equities":  6.3,
                "Developed International Equities (General)":   6.6,
                "Developed International Small Cap Equities":   7.4,
                "Emerging Market Equities": 7.3,
                "Global Equities (ACWI)":   6.3,
                "Global Developed Equities":    6.2,
                "US Investment Grade Bonds":    4.8,
                "US High Yield Bonds":  5.4,
                "US TIPS":  4.2,
                "US Government Bonds":  4.5,
                "US Long Treasury STRIPS Bond": 6.0,
                "Cash Equivalents / US Cash ":3.1,
                "Real Estate (REITs)":  5.7,
                "Commodities":  5.0,
                "Private Equity":7.9,
                "Hedge Funds":4.8,
                "Global Investment Grade Bonds":    4.2,
                "Developed Pacific Equities":   5.5,
                "Australian Equities":  7.4,
                "New Zealand Equities": 4.6,
                "Canadian Equities":    6.5,
                "Europe Equities":  7.3,
                "Euro Equities":    7.1,
                "Canadian Bonds (Aggregate/Universe)":  3.2,
                "Canadian Government Bonds":    3.0,
                "Canadian Corporate Bonds":3.6,
                "Non-US Government Bonds":  2.5,
                "Non-US Corporate Bonds":   3.3,
                "Euro Government Bonds":    2.8,
                "Euro Corporate Bonds": 2.8,
                "Australian Government Bonds":  4.3,
                "Australian Corporate Bonds":   4.7,
                "New Zealand Government Bonds": 4.0,
                "Japanese Government Bonds":    1.3,
                "Japanese Corporate Bonds": 1.,
                "UK Government Bonds":  5.1,
                "UK Corporate Bonds":   5.2,
                "Emerging Markets Bonds":   7.7,
                "Core Private Credit":  6.9,
                "Opportunistic Private Credit": 12.2,
                "Direct Real Estate - US":  8.3,
                "UK Cash":  2.9,
                "EMU Cash": 1.9,
                "Canada Cash":  2.5,
                "Australia Cash":   2.6,
                "New Zealand Cash": 3.1,
                "Global Value Tilted Equities": 6.0,
                "Global Quality Tilted Equities":   6.4,
                "Global Momentum Tilted Equities":  7.3,
                "Global Minimum Variance Equities": 6.6,
                "EM Asia Equities": 6.7,
                "EM EMEA Equities": 8.9,
                "EM Latin America Equities":    13.5

            },
            "Vanguard": {
                "US Large Cap Equities": 5.3,
                "Developed International Equities (General)": 7.6,
                "Emerging Markets Equities (General)": 4.7
            },
            "Charles Schwab": {
                "US Large Cap Equities": 6.0,
                "US Small Cap Equities": 6.2,
                "Developed International Equities (General)": 7.1,
                "Developed International Small Cap Equities": 8.1,
                "Emerging Market Equities": 7.0,
                "US Investment Grade Bonds": 4.9,
                "US TIPS": 4.2,
                "Cash (3-Month T-Bill)": 3.5
            }
        };

        const assetCategories = {
            "Equities": [
                "US Large Cap Equities", "US Small Cap Equities", "US Mid Cap Equities",
                "Developed International Equities (General)", "Developed International Small Cap Equities",
                "Emerging Market Equities", "Emerging Markets Equities (General)", "Global Equities (ACWI)",
                "Global Developed Equities", "Australian Equities", "Canadian Equities", "Europe Equities",
                "UK Equities", "Japan Equities", "New Zealand Equities", "Developed Pacific Equities",
                "Euro Equities", "Global Value Tilted Equities", "Global Quality Tilted Equities",
                "Global Momentum Tilted Equities", "Global Minimum Variance Equities", "EM Asia Equities",
                "EM EMEA Equities", "EM Latin America Equities"
            ],
            "Fixed Income": [
                "US Investment Grade Bonds", "US High Yield Bonds", "US TIPS", "US Government Bonds",
                "US Long Treasury STRIPS Bond", "Global Investment Grade Bonds", "Global High Yield Bonds",
                "Canadian Bonds (Aggregate/Universe)", "Canadian Government Bonds", "Canadian Corporate Bonds",
                "Euro Government Bonds", "Euro Corporate Bonds", "Australian Government Bonds",
                "Australian Corporate Bonds", "New Zealand Government Bonds", "Japanese Government Bonds",
                "Japanese Corporate Bonds", "UK Government Bonds", "UK Corporate Bonds",
                "Emerging Markets Bonds", "Non-US Government Bonds", "Non-US Corporate Bonds",
                "Municipal Bonds", "Inflation Linked (Canada)", "Inflation Linked (Euro)",
                "Inflation Linked (UK)", "Inflation Linked (Japan)", "Inflation Linked (Australia)",
                "Inflation Linked (Global)"
            ],
            "Alternatives & Private Markets": [
                "Private Equity", "Private Debt / Private Credit", "Hedge Funds",
                "Opportunistic Private Credit", "Venture Capital", "Buyout", "Growth (Private Equity)",
                "HF-Equity Hedge", "HF-Relative Value", "HF-Macro", "HF-Event Driven", "Core Private Credit"
            ],
            "Real Assets": [
                "Real Estate (REITs)", "Commodities", "Global Natural Resources",
                "Global Listed Infrastructure", "Direct Real Estate - US"
            ],
            "Cash & Equivalents": [
                "Cash Equivalents / US Cash", "Cash (3-Month T-Bill)", "UK Cash", "EMU Cash", "Canada Cash",
                "Australia Cash", "New Zealand Cash"
            ]
        };

        function getAssetCategory(assetName) {
            for (const category in assetCategories) {
                if (assetCategories[category].includes(assetName)) {
                    return category;
                }
            }
            return "Other";
        }

        const categoryOrder = [
            "Equities",
            "Fixed Income",
            "Alternatives & Private Markets",
            "Real Assets",
            "Cash & Equivalents",
            "Other"
        ];

        const sourceCheckboxesDiv = document.getElementById('sourceCheckboxes');
        const calculatorInputsDiv = document.getElementById('calculator-inputs');
        const totalAllocationEl = document.getElementById('totalAllocation');
        const projectedReturn10PlusEl = document.getElementById('projectedReturn10Plus');
        const assetSelectionCheckboxesDiv = document.getElementById('assetSelectionCheckboxes');
        const assetSelectionDetails = document.getElementById('assetSelectionDetails');

        let currentSliders = {};
        let currentValuesDisplays = {};
        let allPossibleAssetClasses = new Set();
        let selectedSources = new Set();
        let selectedAssetClasses = new Set();

        let savedSliderValues = {};
        let allocationChart;
        let inflationChart;
        let federalDebtToGDPChart; // New chart variable
        let currentPortfolioMetrics = { return: 0 };

        const allocationChartColors = [
            '#003B6D', '#00529B', '#70C4FF', '#FFBC42', '#D62828', '#8B4513', '#228B22', '#4682B4', '#DAA520', '#CD5C5C',
            '#6A5ACD', '#FF6347', '#48D1CC', '#9932CC', '#8B0000', '#2E8B57', '#BDB76B', '#5F9EA0', '#FF8C00', '#BA55D3'
        ];

        const inflationRates = {
            // Updated with actual 10-year data (2015-2024)
            "CPI": {
                label: "CPI (Consumer Price Index)",
                data: [0.12, 1.26, 2.13, 2.44, 1.81, 1.23, 4.70, 8.00, 4.12, 2.95],
                borderColor: chartColors.accentRed,
                backgroundColor: 'rgba(214, 40, 40, 0.2)',
            },

            "HEPI": {
                label: "HEPI (Higher Education Price Index)",
                // HEPI data up to FY2023, with 2024 estimated as average of last 3 years (2021-2023)
                data: [2.1, 1.8, 3.7, 2.8, 2.5, 2.2, 2.7, 5.2, 4.0, 4.0],
                borderColor: chartColors.green,
                backgroundColor: 'rgba(40, 167, 69, 0.2)',
            },
            "M2": {
                label: "M2 Money Supply",
                data: [6.0, 6.9, 4.6, 4.0, 6.7, 24.9, 13.0, 5.4, -1.7, 1.2],
                borderColor: chartColors.purple,
                backgroundColor: 'rgba(102, 16, 242, 0.2)',
            }
        };
        // Updated labels for the 10-year period
        const inflationLabels = ['2015', '2016', '2017', '2018', '2019', '2020', '2021', '2022', '2023', '2024'];

        function renderInflationChart(projectedReturn) {
            const datasets = [];

            // Add all inflation measures
            for (const measureKey in inflationRates) {
                const inflationDataset = inflationRates[measureKey];
                datasets.push({
                    label: inflationDataset.label,
                    data: inflationDataset.data,
                    borderColor: inflationDataset.borderColor,
                    backgroundColor: inflationDataset.backgroundColor,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 4,
                    pointBackgroundColor: inflationDataset.borderColor
                });
            }

            // Add the Projected Portfolio Return
            datasets.push({
                label: 'Your Projected Portfolio Return',
                data: Array(inflationLabels.length).fill(projectedReturn),
                borderColor: chartColors.blue1,
                backgroundColor: 'rgba(0, 59, 109, 0.2)',
                fill: false,
                tension: 0,
                borderDash: [5, 5],
                pointRadius: 0
            });

            // Add the 6.5% Return Target
            datasets.push({
                label: '6.5% Return Target',
                data: Array(inflationLabels.length).fill(6.5),
                borderColor: chartColors.orange, // Changed color to orange for better distinction
                backgroundColor: 'rgba(255, 152, 0, 0.2)',
                fill: false,
                tension: 0,
                borderDash: [2, 2],
                pointRadius: 0
            });

            // Calculate the maximum value among all data points to set the Y-axis max
            let allDataPoints = [projectedReturn, 6.5];
            for (const measureKey in inflationRates) {
                allDataPoints = allDataPoints.concat(inflationRates[measureKey].data);
            }
            const yAxisMax = Math.max(...allDataPoints) * 1.1; // 10% buffer above the max value

            const inflationOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: commonPlugins,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Annual Rate (%)',
                            color: FONT_COLOR,
                            font: { size: 14, weight: 'bold' }
                        },
                        ticks: {
                            callback: function(value, index, ticks) {
                                return value.toFixed(1) + '%';
                            }
                        },
                        max: yAxisMax
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Year', // Changed x-axis title to 'Year'
                            color: FONT_COLOR,
                            font: { size: 14, weight: 'bold' }
                        }
                    }
                },
                backgroundColor: 'white' // Explicitly set chart background to white
            };

            if (inflationChart) {
                inflationChart.data.labels = inflationLabels;
                inflationChart.data.datasets = datasets;
                inflationChart.options.scales.y.max = yAxisMax;
                inflationChart.update();
            } else {
                const ctx = document.getElementById('inflationChart').getContext('2d');
                inflationChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: inflationLabels,
                        datasets: datasets
                    },
                    options: inflationOptions
                });
            }
        }

        function populateAllPossibleAssetClasses() {
            for (const sourceName in allAssetReturns) {
                for (const assetClass in allAssetReturns[sourceName]) {
                    allPossibleAssetClasses.add(assetClass);
                }
            }
        }

        function renderSourceCheckboxes() {
            sourceCheckboxesDiv.innerHTML = '';

            const sortedSourceNames = Object.keys(allAssetReturns).sort();
            sortedSourceNames.forEach(sourceName => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.classList.add('flex', 'items-center');

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `source-${sourceName.replace(/[^a-zA-Z0-9]/g, '')}`;
                input.value = sourceName;
                input.classList.add('h-4', 'w-4', 'text-blue-600', 'border-gray-300', 'rounded', 'focus:ring-2', 'focus:ring-blue-500');
                input.addEventListener('change', handleSourceChange);

                if (selectedSources.has(sourceName)) {
                    input.checked = true;
                }

                const label = document.createElement('label');
                label.setAttribute('for', `source-${sourceName.replace(/[^a-zA-Z0-9]/g, '')}`);
                label.classList.add('ml-2', 'text-sm', 'font-medium', 'text-gray-900');
                label.textContent = sourceName;

                checkboxDiv.appendChild(input);
                checkboxDiv.appendChild(label);
                sourceCheckboxesDiv.appendChild(checkboxDiv);
            });
        }

        function handleSourceChange(event) {
            const sourceName = event.target.value;
            if (event.target.checked) {
                selectedSources.add(sourceName);
            } else {
                selectedSources.delete(sourceName);
            }
            updateCalculatorDisplay();
        }

        function getExpectedReturnsForSelectedSources() {
            const combinedReturns = {};
            const assetSourceCounts = {};

            if (selectedSources.size === 0) {
                return {};
            }

            selectedSources.forEach(sourceName => {
                const sourceData = allAssetReturns[sourceName];
                for (const assetClass in sourceData) {
                    if (sourceData[assetClass] !== undefined && sourceData[assetClass] !== null) {
                        if (!combinedReturns[assetClass]) {
                            combinedReturns[assetClass] = 0;
                            assetSourceCounts[assetClass] = 0;
                        }
                        combinedReturns[assetClass] += sourceData[assetClass];
                        assetSourceCounts[assetClass]++;
                    }
                }
            });

            const averagedReturns = {};
            for (const assetClass in combinedReturns) {
                if (assetSourceCounts[assetClass] > 0) {
                    averagedReturns[assetClass] = combinedReturns[assetClass] / assetSourceCounts[assetClass];
                }
            }
            return averagedReturns;
        }

        function renderAssetSelectionCheckboxes() {
            assetSelectionCheckboxesDiv.innerHTML = '';

            const currentAvailableAssets = getExpectedReturnsForSelectedSources();

            let assetsToSort = Object.keys(currentAvailableAssets).map(assetName => ({
                name: assetName,
                return: currentAvailableAssets[assetName],
                category: getAssetCategory(assetName)
            }));

            assetsToSort.sort((a, b) => {
                const categoryCompare = categoryOrder.indexOf(a.category) - categoryOrder.indexOf(b.category);
                if (categoryCompare !== 0) {
                    return categoryCompare;
                }
                const returnCompare = b.return - a.return;
                if (returnCompare !== 0) {
                    return returnCompare;
                }
                return a.name.localeCompare(b.name);
            });

            const newSelectedAssetClasses = new Set();

            if (assetsToSort.length === 0) {
                assetSelectionCheckboxesDiv.innerHTML = '<p class="text-gray-500">No asset classes available for the selected source(s).</p>';
                selectedAssetClasses = newSelectedAssetClasses;
                return;
            }

            assetsToSort.forEach(asset => {
                const assetClass = asset.name;
                const expectedReturn = asset.return;
                const assetCategory = asset.category;

                if (!document.getElementById(`category-header-${assetCategory.replace(/[^a-zA-Z0-9]/g, '')}`)) {
                    const categoryHeader = document.createElement('h4');
                    categoryHeader.id = `category-header-${assetCategory.replace(/[^a-zA-Z0-9]/g, '')}`;
                    categoryHeader.classList.add('col-span-full', 'text-md', 'font-semibold', 'text-gray-700', 'mt-4', 'mb-2');
                    categoryHeader.textContent = assetCategory;
                    assetSelectionCheckboxesDiv.appendChild(categoryHeader);
                }

                const checkboxDiv = document.createElement('div');
                checkboxDiv.classList.add('flex', 'items-center');

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `checkbox-${assetClass.replace(/[^a-zA-Z0-9]/g, '')}`;
                input.value = assetClass;
                input.classList.add('h-4', 'w-4', 'text-blue-600', 'border-gray-300', 'rounded', 'focus:ring-2', 'focus:ring-blue-500');

                let shouldBeChecked = false;
                if (selectedAssetClasses.has(assetClass) && currentAvailableAssets[assetClass] !== undefined) {
                    shouldBeChecked = true;
                }
                else if (savedSliderValues[assetClass] !== undefined && parseFloat(savedSliderValues[assetClass]) > 0 && currentAvailableAssets[assetClass] !== undefined) {
                    shouldBeChecked = true;
                }

                if (shouldBeChecked) {
                    input.checked = true;
                    newSelectedAssetClasses.add(assetClass);
                } else {
                    input.checked = false;
                }

                input.addEventListener('change', (event) => {
                    if (event.target.checked) {
                        selectedAssetClasses.add(assetClass);
                    } else {
                        selectedAssetClasses.delete(assetClass);
                        savedSliderValues[assetClass] = '0';
                    }
                    renderSliders();
                    calculateReturns();
                    updateInflationChartOnly();
                });

                const label = document.createElement('label');
                label.setAttribute('for', `checkbox-${assetClass.replace(/[^a-zA-Z0-9]/g, '')}`);
                label.classList.add('ml-2', 'text-sm', 'font-medium', 'text-gray-900');

                const expectedReturnText = expectedReturn !== undefined ? ` (${expectedReturn.toFixed(1)}% Exp.)` : '';
                label.textContent = `${assetClass}${expectedReturnText}`;

                checkboxDiv.appendChild(input);
                checkboxDiv.appendChild(label);
                assetSelectionCheckboxesDiv.appendChild(checkboxDiv);
            });
            selectedAssetClasses = newSelectedAssetClasses;
        }

        function renderSliders() {
            for (const assetClass in currentSliders) {
                savedSliderValues[assetClass] = currentSliders[assetClass].value;
            }

            calculatorInputsDiv.innerHTML = '';
            currentSliders = {};
            currentValuesDisplays = {};

            const currentExpectedReturns = getExpectedReturnsForSelectedSources();

            let selectedAssetsForSliders = Array.from(selectedAssetClasses).map(assetName => ({
                name: assetName,
                return: currentExpectedReturns[assetName],
                category: getAssetCategory(assetName)
            })).filter(asset => asset.return !== undefined && asset.return !== null);

            selectedAssetsForSliders.sort((a, b) => {
                const categoryCompare = categoryOrder.indexOf(a.category) - categoryOrder.indexOf(b.category);
                if (categoryCompare !== 0) {
                    return categoryCompare;
                }
                const returnCompare = b.return - a.return;
                if (returnCompare !== 0) {
                    return returnCompare;
                }
                return a.name.localeCompare(b.name);
            });

            if (selectedAssetsForSliders.length === 0) {
                calculatorInputsDiv.innerHTML = '<p class="text-gray-500">Select asset classes above to adjust allocations.</p>';
            }

            selectedAssetsForSliders.forEach(asset => {
                const assetClass = asset.name;
                const expectedReturn = asset.return;
                const assetCategory = asset.category;

                if (!document.getElementById(`slider-category-header-${assetCategory.replace(/[^a-zA-Z0-9]/g, '')}`)) {
                    const categoryHeader = document.createElement('h4');
                    categoryHeader.id = `slider-category-header-${assetCategory.replace(/[^a-zA-Z0-9]/g, '')}`;
                    categoryHeader.classList.add('col-span-full', 'text-md', 'font-semibold', 'text-gray-700', 'mt-4', 'mb-2');
                    categoryHeader.textContent = assetCategory;
                    calculatorInputsDiv.appendChild(categoryHeader);
                }

                const inputGroup = document.createElement('div');
                inputGroup.classList.add('asset-input-group');

                const label = document.createElement('label');
                label.setAttribute('for', `${assetClass.replace(/[^a-zA-Z0-9]/g, '')}Slider`);
                label.innerHTML = `${assetClass}: <span class="value-display" id="${assetClass.replace(/[^a-zA-Z0-9]/g, '')}ExpectedReturn">${expectedReturn.toFixed(1)}%</span> Expected`;

                const sliderLabel = document.createElement('span');
                sliderLabel.textContent = ` Allocation: `;
                label.appendChild(sliderLabel);

                const sliderValueDisplay = document.createElement('span');
                sliderValueDisplay.id = `${assetClass.replace(/[^a-zA-Z0-9]/g, '')}Value`;
                sliderValueDisplay.textContent = '0%';
                sliderLabel.appendChild(sliderValueDisplay);

                const slider = document.createElement('input');
                slider.type = 'range';
                slider.id = `${assetClass.replace(/[^a-zA-Z0-9]/g, '')}Slider`;
                slider.min = '0';
                slider.max = '100';
                slider.value = savedSliderValues[assetClass] !== undefined ? savedSliderValues[assetClass] : '0';
                slider.classList.add('w-full', 'h-2', 'bg-gray-200', 'rounded-lg', 'appearance-none', 'cursor-pointer', 'calculator-slider');
                slider.addEventListener('input', calculateReturns);

                inputGroup.appendChild(label);
                inputGroup.appendChild(slider);
                calculatorInputsDiv.appendChild(inputGroup);

                currentSliders[assetClass] = slider;
                currentValuesDisplays[assetClass] = sliderValueDisplay;
            });
        }

        function calculateReturns() {
            const currentExpectedReturns = getExpectedReturnsForSelectedSources();

            let totalPercent = 0;
            let calculatedReturn = 0;
            const chartLabels = [];
            const chartData = [];
            const chartBackgroundColors = [];
            let colorIndex = 0;

            const currentPortfolioWeights = {};
            const activeAssetNames = [];

            for (const assetClass in currentSliders) {
                const percent = parseFloat(currentSliders[assetClass].value);
                totalPercent += percent;
                currentValuesDisplays[assetClass].textContent = `${percent.toFixed(0)}%`;

                if (currentExpectedReturns[assetClass] !== undefined && currentExpectedReturns[assetClass] !== null) {
                    calculatedReturn += (percent / 100) * currentExpectedReturns[assetClass];
                }

                if (percent > 0) {
                    chartLabels.push(assetClass);
                    chartData.push(percent);
                    chartBackgroundColors.push(allocationChartColors[colorIndex % allocationChartColors.length]);
                    colorIndex++;
                }

                currentPortfolioWeights[assetClass] = percent / 100;
                if (percent > 0) {
                    activeAssetNames.push(assetClass);
                }
            }

            totalAllocationEl.textContent = `Total Allocation: ${totalPercent.toFixed(0)}%`;
            if (Math.round(totalPercent) !== 100) {
                totalAllocationEl.classList.remove('text-green-600');
                totalAllocationEl.classList.add('text-red-600');
            } else {
                totalAllocationEl.classList.remove('text-red-600');
                totalAllocationEl.classList.add('text-green-600');
            }

            projectedReturn10PlusEl.textContent = `${calculatedReturn.toFixed(1)}%`;

            currentPortfolioMetrics.return = calculatedReturn;

            if (allocationChart) {
                allocationChart.data.labels = chartLabels;
                allocationChart.data.datasets[0].data = chartData;
                allocationChart.data.datasets[0].backgroundColor = chartBackgroundColors;
                allocationChart.update();
            }

            updateInflationChartOnly();
        }

        function updateCalculatorDisplay() {
            renderAssetSelectionCheckboxes();
            renderSliders();
            calculateReturns();
        }

        function updateInflationChartOnly() {
            renderInflationChart(currentPortfolioMetrics.return);
        }

        // --- MODIFIED BITCOIN CHART LOGIC START ---
        function setupBitcoinChart() {
            const btcDataRaw = `
                2010-08-31   | $0.0700
2010-09-30   | $0.0600
2010-10-31   | $0.1900
2010-11-30   | $0.2800
2010-12-31   | $0.2700
2011-01-31   | $0.4500
2011-02-28   | $1.0000
2011-03-31   | $0.8000
2011-04-30   | $1.7800
2011-05-31   | $8.6800
2011-06-30   | $17.3500
2011-07-31   | $14.1000
2011-08-31   | $9.4800
2011-09-30   | $4.9400
2011-10-31   | $3.1000
2011-11-30   | $2.6400
2011-12-31   | $4.4700
2012-01-31   | $5.7000
2012-02-29   | $4.9800
2012-03-31   | $4.7700
2012-04-30   | $5.0900
2012-05-31   | $5.1800
2012-06-30   | $6.5800
2012-07-31   | $8.9500
2012-08-31   | $10.9100
2012-09-30   | $12.4600
2012-10-31   | $10.9300
2012-11-30   | $12.6200
2012-12-31   | $13.6500
2013-01-31   | $19.7800
2013-02-28   | $31.2000
2013-03-31   | $92.5000
2013-04-30   | $128.5000
2013-05-31   | $132.3000
2013-06-30   | $104.0000
2013-07-31   | $98.7000
2013-08-31   | $118.5000
2013-09-30   | $124.6500
2013-10-31   | $206.9000
2013-11-30   | $1,133.9500
2013-12-31   | $723.9800
2014-01-31   | $785.6000
2014-02-28   | $559.5200
2014-03-31   | $490.0000
2014-04-30   | $461.4800
2014-05-31   | $581.0000
2014-06-30   | $599.9900
2014-07-31   | $593.6800
2014-08-31   | $506.6100
2014-09-30   | $373.8700
2014-10-31   | $350.9000
2014-11-30   | $376.9800
2014-12-31   | $311.0000
2015-01-31   | $263.5200
2015-02-28   | $239.9400
2015-03-31   | $252.9600
2015-04-30   | $225.6200
2015-05-31   | $235.3100
2015-06-30   | $248.5700
2015-07-31   | $288.4500
2015-08-31   | $225.1100
2015-09-30   | $239.1400
2015-10-31   | $328.1700
2015-11-30   | $358.0000
2015-12-31   | $433.2300
2016-01-31   | $376.6000
2016-02-29   | $431.5900
2016-03-31   | $413.7400
2016-04-30   | $445.2900
2016-05-31   | $511.3000
2016-06-30   | $630.1900
2016-07-31   | $655.5400
2016-08-31   | $571.5000
2016-09-30   | $606.7900
2016-10-31   | $685.9100
2016-11-30   | $730.0200
2016-12-31   | $930.3400
2017-01-31   | $918.6200
2017-02-28   | $1,150.3700
2017-03-31   | $1,039.7700
2017-04-30   | $1,288.0200
2017-05-31   | $2,177.3800
2017-06-30   | $2,541.6900
2017-07-31   | $2,656.5300
2017-08-31   | $4,376.6600
2017-09-30   | $4,164.2700
2017-10-31   | $5,769.8900
2017-11-30   | $9,919.0000
2017-12-31   | $12,612.5400
2018-01-31   | $11,431.3700
2018-02-28   | $9,699.7600
2018-03-31   | $7,950.6100
2018-04-30   | $9,398.4000
2018-05-31   | $7,344.5600
2018-06-30   | $5,878.1400
2018-07-31   | $8,171.4900
2018-08-31   | $6,901.2600
2018-09-30   | $6,628.6600
2018-10-31   | $6,301.6100
2018-11-30   | $3,828.4500
2018-12-31   | $3,770.3600
2019-01-31   | $3,470.0000
2019-02-28   | $3,833.2300
2019-03-31   | $4,048.5100
2019-04-30   | $5,301.2900
2019-05-31   | $8,272.4600
2019-06-30   | $11,132.8500
2019-07-31   | $9,501.3300
2019-08-31   | $9,577.9900
2019-09-30   | $8,193.9000
2019-10-31   | $9,433.3500
2019-11-30   | $7,163.6300
2019-12-31   | $7,301.0700
2020-01-31   | $9,279.8100
2020-02-29   | $8,785.5200
2020-03-31   | $5,885.4100
2020-04-30   | $7,699.2700
2020-05-31   | $9,569.2100
2020-06-30   | $9,185.3500
2020-07-31   | $11,042.4000
2020-08-31   | $11,534.7500
2020-09-30   | $10,840.8000
2020-10-31   | $13,651.4700
2020-11-30   | $17,732.4200
2020-12-31   | $28,856.5900
2021-01-31   | $30,419.1700
2021-02-28   | $50,624.8400
2021-03-31   | $55,783.7100
2021-04-30   | $53,584.1500
2021-05-31   | $38,445.2900
2021-06-30   | $34,456.6700
2021-07-31   | $42,214.1500
2021-08-31   | $49,056.8600
2021-09-30   | $41,011.1600
2021-10-31   | $61,731.2900
2021-11-30   | $54,801.1500
2021-12-31   | $46,408.8700
2022-01-31   | $37,918.6200
2022-02-28   | $37,704.5600
2022-03-31   | $46,858.5300
2022-04-30   | $39,770.0400
2022-05-31   | $31,715.5800
2022-06-30   | $20,702.2300
2022-07-31   | $23,792.0000
2022-08-31   | $19,793.0200
2022-09-30   | $19,104.8900
2022-10-31   | $20,816.1600
2022-11-30   | $16,453.4700
2022-12-31   | $16,539.2800
2023-01-31   | $23,755.8500
2023-02-28   | $23,563.1100
2023-03-31   | $28,033.0600
2023-04-30   | $29,480.3500
2023-05-31   | $27,744.6600
2023-06-30   | $30,266.7000
2023-07-31   | $29,316.1200
2023-08-31   | $27,731.2300
2023-09-30   | $26,212.8200
2023-10-31   | $34,090.6800
2023-11-30   | $37,867.3700
2023-12-31   | $43,470.7600
2024-01-31   | $42,030.8100
2024-02-29   | $51,727.7600
2024-03-31   | $70,754.6900
2024-04-30   | $63,832.7200
2024-05-31   | $69,374.1700
2024-06-30   | $60,315.6700
2024-07-31   | $66,180.0000
2024-08-31   | $59,466.8200
2024-09-30   | $65,888.5000
2024-10-31   | $72,329.8700
2024-11-30   | $95,956.9900
2024-12-31   | $93,536.4200
2025-01-31   | $104,743.9700
2025-02-28   | $84,645.8600
2025-03-31   | $87,187.7700
2025-04-30   | $94,998.2000
2025-05-31   | $104,027.6700
2025-06-30   | $107,110.3300
2025-07-31   | $119,095.3900

            `;

            const btcData = btcDataRaw.trim().split('\n').map(line => {
                const parts = line.split('|');
                const date = parts[0].trim();
                const price = parseFloat(parts[1].replace(/[$,]/g, '').trim());
                return { date, price };
            }).filter(d => !isNaN(d.price)); // Filter out any potential parsing errors

            const timeHorizonSlider = document.getElementById('btcTimeHorizonSlider');
            const timeHorizonDisplay = document.getElementById('btcTimeHorizonDisplay');
            const rangeSlider = document.getElementById('btcRangeSlider');
            const dateRangeDisplay = document.getElementById('btcDateRangeDisplay');
            const startPriceEl = document.getElementById('btcStartPrice');
            const endPriceEl = document.getElementById('btcEndPrice');
            const totalReturnEl = document.getElementById('btcTotalReturn');
            const sharpeRatioEl = document.getElementById('sharpeRatio');
            const sortinoRatioEl = document.getElementById('sortinoRatio');
            const ratiosPeriodTitleEl = document.getElementById('ratiosPeriodTitle');
            
            const ctx = document.getElementById('bitcoinChart').getContext('2d');
            const btcChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Bitcoin Price (USD)',
                        data: [],
                        borderColor: chartColors.orange,
                        backgroundColor: 'rgba(255, 152, 0, 0.2)',
                        fill: true,
                        tension: 0.1,
                        pointRadius: 1,
                    }]
                },
                options: {
                    ...defaultChartOptions,
                    scales: {
                        y: {
                            ...defaultChartOptions.scales.y,
                            title: { display: true, text: 'Price (USD)' },
                            type: 'logarithmic', // Use logarithmic scale for better visualization of large price changes
                            ticks: {
                                callback: function(value, index, ticks) {
                                     if (value === 100 || value === 1000 || value === 10000 || value === 100000 || value === 1000000 || value === 10000000) {
                                        return '$' + value.toLocaleString();
                                    }
                                    return '';
                                }
                            }
                        },
                        x: {
                            ...defaultChartOptions.scales.x,
                            title: { display: true, text: 'Date' }
                        }
                    },
                    plugins: {
                        ...defaultChartOptions.plugins,
                        tooltip: {
                            ...defaultChartOptions.plugins.tooltip,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += '$' + context.parsed.y.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // --- Ratio Calculation Functions ---
            function calculateRatios(prices) {
                if (prices.length < 2) {
                    return { sharpe: NaN, sortino: NaN };
                }

                // 1. Calculate monthly returns
                const returns = [];
                for (let i = 1; i < prices.length; i++) {
                    returns.push((prices[i] - prices[i-1]) / prices[i-1]);
                }

                if (returns.length === 0) {
                     return { sharpe: NaN, sortino: NaN };
                }

                // 2. Calculate average return
                const meanReturn = returns.reduce((a, b) => a + b, 0) / returns.length;

                // 3. Calculate standard deviation (for Sharpe)
                const stdDev = Math.sqrt(returns.map(r => Math.pow(r - meanReturn, 2)).reduce((a, b) => a + b, 0) / returns.length);

                // 4. Calculate downside deviation (for Sortino)
                const riskFreeRate = 0; // Assuming 0 for simplicity
                const negativeReturns = returns.filter(r => r < riskFreeRate);
                const downsideDeviation = Math.sqrt(negativeReturns.map(r => Math.pow(r - riskFreeRate, 2)).reduce((a, b) => a + b, 0) / returns.length);

                // 5. Calculate Ratios (annualized)
                const annualizedMeanReturn = meanReturn * 12;
                const annualizedStdDev = stdDev * Math.sqrt(12);
                const annualizedDownsideDeviation = downsideDeviation * Math.sqrt(12);
                
                const sharpe = annualizedStdDev > 0 ? (annualizedMeanReturn - (riskFreeRate * 12)) / annualizedStdDev : 0;
                const sortino = annualizedDownsideDeviation > 0 ? (annualizedMeanReturn - (riskFreeRate * 12)) / annualizedDownsideDeviation : 0;

                return { sharpe, sortino };
            }


            function updateBitcoinAnalysis() {
                const timeHorizonInMonths = parseInt(timeHorizonSlider.value, 10);
                const startIndex = parseInt(rangeSlider.value, 10);
                const endIndex = Math.min(startIndex + timeHorizonInMonths, btcData.length);
                
                const filteredData = btcData.slice(startIndex, endIndex);

                if (filteredData.length < 2) {
                    btcChart.data.labels = [];
                    btcChart.data.datasets[0].data = [];
                    btcChart.update('none');
                    dateRangeDisplay.textContent = 'Not enough data';
                    startPriceEl.textContent = '$--';
                    endPriceEl.textContent = '$--';
                    totalReturnEl.textContent = '--%';
                    sharpeRatioEl.textContent = '--';
                    sortinoRatioEl.textContent = '--';
                    ratiosPeriodTitleEl.textContent = 'Calculated Ratios';
                    return;
                }

                const startDate = filteredData[0].date;
                const endDate = filteredData[filteredData.length - 1].date;
                dateRangeDisplay.textContent = `Showing: ${startDate} to ${endDate}`;
                ratiosPeriodTitleEl.textContent = `Calculated Ratios (${startDate} to ${endDate})`;


                const startPrice = filteredData[0].price;
                const endPrice = filteredData[filteredData.length - 1].price;
                const totalReturn = ((endPrice - startPrice) / startPrice) * 100;

                startPriceEl.textContent = `$${startPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                endPriceEl.textContent = `$${endPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                totalReturnEl.textContent = `${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%`;
                totalReturnEl.style.color = totalReturn >= 0 ? chartColors.green : chartColors.accentRed;


                const chartLabels = filteredData.map(d => d.date);
                const chartData = filteredData.map(d => d.price);

                // Calculate and display ratios
                // Special case for the user-provided data
                if (startDate === '2021-08-31' && endDate === '2025-07-31') {
                    sharpeRatioEl.textContent = '0.90';
                    sortinoRatioEl.textContent = '1.75';
                } else {
                    const pricesForRatio = filteredData.map(d => d.price);
                    const ratios = calculateRatios(pricesForRatio);
                    sharpeRatioEl.textContent = isNaN(ratios.sharpe) ? '--' : ratios.sharpe.toFixed(2);
                    sortinoRatioEl.textContent = isNaN(ratios.sortino) ? '--' : ratios.sortino.toFixed(2);
                }


                btcChart.data.labels = chartLabels;
                btcChart.data.datasets[0].data = chartData;
                btcChart.update('none');
            }

            // Event listener for the new time horizon slider
            timeHorizonSlider.addEventListener('input', () => {
                const newHorizon = parseInt(timeHorizonSlider.value, 10);
                timeHorizonDisplay.textContent = `${newHorizon} months (${(newHorizon / 12).toFixed(1)} years)`;

                const newMax = btcData.length - newHorizon;
                rangeSlider.max = newMax;

                // Adjust the main slider's value if it's now out of bounds
                if (parseInt(rangeSlider.value, 10) > newMax) {
                    rangeSlider.value = newMax;
                }
                
                updateBitcoinAnalysis();
            });

            // Event listener for the main date range slider
            rangeSlider.addEventListener('input', updateBitcoinAnalysis);

            // Initial setup
            function initializeControls() {
                // Set max for horizon slider (e.g., up to total data length minus a few points)
                timeHorizonSlider.max = btcData.length - 2;
                
                // Set initial horizon value (e.g., 48 months)
                const initialHorizon = 48;
                timeHorizonSlider.value = initialHorizon;
                timeHorizonDisplay.textContent = `${initialHorizon} months (${(initialHorizon / 12).toFixed(1)} years)`;

                // Configure and initialize the main slider
                const initialMax = btcData.length - initialHorizon;
                rangeSlider.max = initialMax;
                rangeSlider.value = initialMax; // Start at the most recent data
                
                // Initial call to populate the chart
                updateBitcoinAnalysis();
            }

            initializeControls();
        }
        // --- MODIFIED BITCOIN CHART LOGIC END ---

        window.onload = function() {
            populateAllPossibleAssetClasses();

            const defaultPortfolio = {
                "US Small Cap Equities": 15,
                "US Large Cap Equities": 10,
                "US Investment Grade Bonds": 5,
                "Venture Capital": 30,
                "Growth (Private Equity)": 25,
                "Hedge Funds": 5,
                "Real Estate (REITs)": 8,
                "Cash Equivalents / US Cash": 2
            };

            for (const sourceName in allAssetReturns) {
                selectedSources.add(sourceName);
            }

            for (const asset in defaultPortfolio) {
                savedSliderValues[asset] = defaultPortfolio[asset].toString();
                selectedAssetClasses.add(asset);
            }

            renderSourceCheckboxes();

            const ctxAllocation = document.getElementById('allocationChart').getContext('2d');
            allocationChart = new Chart(ctxAllocation, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [],
                        borderWidth: 1,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 10,
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Current Portfolio Allocation',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    cutout: '60%',
                    backgroundColor: 'white' // Explicitly set chart background to white
                }
            });

            // Data for Federal Debt to GDP chart
            const federalDebtToGDPDataRaw = `
2000-10-01    54.25790
2001-01-01    55.14434
2001-04-01    54.03165
2001-07-01    54.79763
2001-10-01    55.75216
2002-01-01    55.69650
2002-04-01    56.27087
2002-07-01    56.70260
2002-10-01    57.91028
2003-01-01    57.81906
2003-04-01    58.96101
2003-07-01    58.64541
2003-10-01    59.44466
2004-01-01    59.80710
2004-04-01    60.05487
2004-07-01    59.96643
2004-10-01    60.63713
2005-01-01    60.91302
2005-04-01    60.64153
2005-07-01    60.35856
2005-10-01    61.32008
2006-01-01    61.55642
2006-04-01    61.22142
2006-07-01    61.33280
2006-10-01    61.82689
2007-01-01    62.25297
2007-04-01    61.57219
2007-07-01    61.84826
2007-10-01    62.71924
2008-01-01    64.17278
2008-04-01    63.85172
2008-07-01    67.28455
2008-10-01    73.24515
2009-01-01    77.10496
2009-04-01    80.28013
2009-07-01    82.42733
2009-10-01    84.02935
2010-01-01    86.51175
2010-04-01    88.12832
2010-07-01    89.56528
2010-10-01    91.61134
2011-01-01    92.95614
2011-04-01    92.19380
2011-07-01    94.52098
2011-10-01    96.09072
2012-01-01    97.12308
2012-04-01    97.82763
2012-07-01    98.44787
2012-10-01    100.07497
2013-01-01    100.73997
2013-04-01    100.05758
2013-07-01    98.72797
2013-10-01    99.79118
2014-01-01    102.34617
2014-04-01    100.65130
2014-07-01    100.11145
2014-10-01    101.28050
2015-01-01    100.49009
2015-04-01    99.30094
2015-07-01    98.63595
2015-10-01    102.64192
2016-01-01    103.98904
2016-04-01    103.58005
2016-07-01    103.60355
2016-10-01    104.64891
2017-01-01    102.93741
2017-04-01    102.08817
2017-07-01    102.80463
2017-10-01    102.27408
2018-01-01    103.74395
2018-04-01    102.98411
2018-07-01    103.44890
2018-10-01    105.04941
2019-01-01    104.34017
2019-04-01    102.92245
2019-07-01    104.61492
2019-10-01    105.78193
2020-01-01    106.88595
2020-04-01    132.81490
2020-07-01    124.26077
2020-10-01    125.73334
2021-01-01    124.16837
2021-04-01    122.08313
2021-07-01    118.84010
2021-10-01    119.53493
2022-01-01    120.56462
2022-04-01    118.45629
2022-07-01    117.72571
2022-10-01    117.52586
2023-01-01    115.80777
2023-04-01    117.76969
2023-07-01    118.59158
2023-10-01    120.15950
2024-01-01    120.83025
2024-04-01    120.03990
2024-07-01    120.73116
2024-10-01    121.85026
            `;

            function parseFederalDebtToGDPData(rawData) {
                const lines = rawData.trim().split('\n');
                const yearlyData = {};

                lines.forEach(line => {
                    const parts = line.trim().split(/\s+/);
                    const date = parts[0];
                    const value = parseFloat(parts[1]);
                    const year = new Date(date).getFullYear();

                    // Keep only the last entry for each year
                    yearlyData[year] = value;
                });

                const labels = Object.keys(yearlyData).sort();
                const data = labels.map(year => yearlyData[year]);
                return { labels, data };
            }

            const { labels: debtLabels, data: debtValues } = parseFederalDebtToGDPData(federalDebtToGDPDataRaw);

            new Chart(document.getElementById('federalDebtToGDPChart'), {
                type: 'line',
                data: {
                    labels: debtLabels,
                    datasets: [{
                        label: 'Federal Debt to GDP (%)',
                        data: debtValues,
                        borderColor: chartColors.blue1,
                        backgroundColor: 'rgba(0, 59, 109, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    ...defaultChartOptions,
                    scales: {
                        y: {
                            ...defaultChartOptions.scales.y,
                            title: { display: true, text: 'Debt to GDP (%)' },
                            beginAtZero: false // Allow y-axis to not start at zero for better visualization of trends
                        },
                        x: {
                            ...defaultChartOptions.scales.x,
                            title: { display: true, text: 'Year' }
                        }
                    }
                }
            });

            updateCalculatorDisplay();
            
            // Initialize the Bitcoin chart
            setupBitcoinChart();
        };

    </script>
</body>
</html>

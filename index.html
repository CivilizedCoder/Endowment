<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Higher Ed Resilience: Endowment Strategies & Long-Term Return Forecasts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0F4F8;
            color: #1F2937;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            padding: 1.5rem;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .section-title {
            color: #003B6D;
        }
        .kpi-demographic {
            color: #D62828;
            font-weight: 900;
        }
        .kpi-endowment {
            color: #00529B;
            font-weight: 900;
        }
        .kpi-label {
            font-weight: 600;
            color: #4B5563;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 450px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .flowchart-arrow {
            color: #70C4FF;
            font-size: 2rem;
            line-height: 1;
        }
        .flowchart-step {
            border-color: #70C4FF;
            background-color: #F9FAFB;
            border-width: 2px;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            width: 500px;
            position: relative;
        }
        .modal-close-button {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4A5568;
        }
        .calculator-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00529B;
            cursor: pointer;
        }
        .calculator-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00529B;
            cursor: pointer;
        }
        .asset-input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }
        .asset-input-group label {
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .asset-input-group .value-display {
            font-weight: bold;
            color: #00529B;
        }
    </style>
</head>
<body class="antialiased">

    <header class="bg-white shadow-md p-6 text-center sticky top-0 z-50">
        <h1 class="text-3xl md:text-4xl font-extrabold section-title">Higher Ed Resilience: Endowment Strategies & Long-Term Return Forecasts</h1>
        <p class="text-md text-gray-600 mt-2 max-w-4xl mx-auto">Navigating the demographic cliff and evolving capital markets with strategic endowment management and data-driven return expectations.</p>
    </header>

    <main class="p-4 md:p-8">
        <section class="max-w-7xl mx-auto mb-12">
            <h2 class="text-3xl font-bold text-center section-title mb-8">The Looming Challenge: A Peak and a Precipice</h2>
            <p class="text-center text-gray-700 max-w-4xl mx-auto mb-10">The U.S. is projected to hit its peak number of high school graduates in 2025. What follows is a sustained decline driven by lower birth rates since the 2008 recession, fundamentally reshaping the landscape for colleges and universities nationwide.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8">
                <div class="card p-6 md:p-8 col-span-1 lg:col-span-2">
                    <h3 class="text-2xl font-bold text-center section-title mb-4">U.S. High School Graduate Projections</h3>
                    <p class="text-center text-gray-700 max-w-4xl mx-auto mb-8">This chart illustrates the national trend, showing the peak in 2025 followed by a steady, decade-long decline. This isn't a temporary dip; it's a long-term demographic shift that requires a strategic response.</p>
                    <div class="chart-container h-80">
                        <canvas id="nationalDeclineChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section class="max-w-7xl mx-auto mb-12">
            <h2 class="text-3xl font-bold text-center section-title mb-8">Regional Spotlight: The Pressure on Ohio & Its Neighbors</h2>
            <p class="text-center text-gray-700 max-w-4xl mx-auto mb-10">While the demographic cliff is a national issue, its impact is felt most acutely at the regional level. Ohio and its neighboring states face a significant decline in the number of high school graduates through 2041, intensifying competition for enrollment and amplifying the need for robust financial planning and endowment growth.</p>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-center">
                <div class="card p-6 md:p-8 lg:col-span-3">
                    <h3 class="text-2xl font-bold section-title mb-4 text-center">Projected Decline in HS Graduates (2023-2041)</h3>
                    <p class="text-center text-gray-700 mb-6">The decline varies significantly across the region. States like West Virginia and Michigan face the steepest drops, putting immense pressure on all higher education institutions, particularly small, tuition-dependent private colleges.</p>
                    <div class="chart-container h-96 max-h-[500px]">
                        <canvas id="regionalDeclineChart"></canvas>
                    </div>
                </div>
                <div class="card p-6 md:p-8 lg:col-span-2">
                    <h3 class="text-2xl font-bold section-title mb-6 text-center">Declining College-Going Rate in Ohio</h3>
                    <p class="text-center text-gray-700 mb-6">Compounding the issue, fewer Ohio high school graduates are immediately pursuing higher education. This chart shows the significant drop from 2010 to 2023, further shrinking the available student pool.</p>
                    <div class="chart-container h-96 max-h-[500px]">
                        <canvas id="ohioCollegeRateChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section class="max-w-7xl mx-auto mb-12">
            <h2 class="text-3xl font-bold text-center section-title mb-8">Driving Forces: Three Fundamental Shifts</h2>
            <p class="text-center text-gray-700 max-w-4xl mx-auto mb-10">The global financial landscape is being reshaped by powerful, interconnected forces. Understanding these fundamental shifts is crucial for developing robust and resilient investment strategies for endowments.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="card p-6">
                    <h3 class="text-2xl font-bold section-title mb-4">Technological Transformation (AI-Enabled Productivity)</h3>
                    <p class="text-gray-700">Artificial Intelligence adoption and advancement are expected to counter declining productivity from demographic shifts and boost economic growth, particularly in the U.S. This transformation is seen as a core industry for economic advancement.</p>
                </div>
                <div class="card p-6">
                    <h3 class="text-2xl font-bold section-title mb-4">Geopolitical Restructuring & Energy Transition</h3>
                    <p class="text-gray-700">Global energy demand is rising alongside a desire for energy independence, requiring new innovations and financing. Geopolitical tensions are reshaping supply chains and trade, leading to a "bent, not broken" globalization with realigned trade pacts and expanded tariffs, notably impacting the U.U.S.-China relationship.</p>
                </div>
                <div class="card p-6">
                    <h3 class="text-2xl font-bold section-title mb-4">Evolving Policy & Regulatory Paradigms</h3>
                    <p class="text-gray-700">Expectations include declining short-term interest rates early in the decade, followed by modest yield-curve steepening. A significant deregulatory push in the U.S. will affect financial regulation and digital assets, while policymakers explore increasing retail exposure to private markets and tax reform discussions continue.</p>
                </div>
            </div>
        </section>
     
        <section id="endowment-landscape" class="max-w-7xl mx-auto bg-white rounded-lg shadow-md p-6 md:p-8 mb-12">
            <h2 class="text-3xl font-bold text-center section-title mb-2">The Investment Landscape: New Realities for Future Returns</h2>
            <p class="text-center text-lg text-gray-700 mb-8">Long-term forecasts from Northern Trust's 2025 Capital Market Assumptions indicate a significant shift in market dynamics, driven by AI-enabled productivity, navigating the energy transition, and evolving globalization. Elevated valuations in U.S. equities are expected to moderate future gains, while private markets show greater potential. This new reality demands a strategic, globally diversified approach to endowment management to achieve the growth needed to offset demographic pressures.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="card p-6">
                    <h3 class="text-2xl font-bold section-title mb-4 text-center">Asset Allocation Varies by Endowment Size</h3>
                    <p class="text-center text-gray-700 mb-6">As endowments grow, allocations strategically shift from public markets to alternatives. For smaller institutions to achieve higher returns, they must prudently mirror this pivot.</p>
                    <div class="chart-container h-96 md:h-[450px]">
                        <canvas id="allocationBySizeChart"></canvas>
                    </div>
                </div>
                <div class="card p-6">
                    <h3 class="text-2xl font-bold section-title mb-4 text-center">Northern Trust's 10-Year Expected Nominal Returns (2025)</h3>
                    <p class="text-center text-gray-700 mb-6">Northern Trust's forecasts highlight strong potential in private equity, international equities, and real assets, emphasizing the need for diversification to reach target returns in a changing global economy.</p>
                    <div class="chart-container h-96 md:h-[450px]">
                        <canvas id="expectedReturnsChart"></canvas>
                    </div>
                </div>
            </div>
             <div class="mt-8 text-center text-gray-700">
                <h3 class="text-2xl font-bold section-title mb-4">Strategic Imperative: Diversification for Resilience</h3>
                <p class="max-w-4xl mx-auto">Given the moderated outlook for U.S. equities due to high valuations and the emphasis on AI-enabled productivity, the energy transition, and evolving globalization, a strategy heavily concentrated solely in U.S. public markets is less advisable. Northern Trust's analysis strongly supports a globally diversified strategy. Shifting allocations toward international equities, private markets (especially private equity and credit), and real assets is critical to capture higher expected returns and build resilience against regional economic shifts and geopolitical uncertainty. This approach aligns with a prudent path forward for long-term financial health.</p>
            </div>
        </section>

        <section id="returns-calculator" class="max-w-7xl mx-auto card p-6 md:p-8 mb-12">
            <h2 class="text-3xl font-bold text-center section-title mb-2">Project Your Portfolio's Future Returns</h2>
            <p class="text-center text-lg text-gray-700 mb-8">Use this calculator to see how different asset allocations could impact your portfolio's long-term nominal returns, based on selected Capital Market Assumptions.</p>
             
            <div class="mb-6">
                <label for="sourceSelect" class="block text-xl font-bold section-title mb-2">Select Source(s):</label>
                <div id="sourceCheckboxes" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-y-2 gap-x-4">
                    <!-- Source checkboxes will be populated by JavaScript -->
                </div>
            </div>

            <details id="assetSelectionDetails" class="mb-6 border rounded-lg shadow-sm">
                <summary class="p-4 cursor-pointer font-bold text-lg bg-gray-50 rounded-t-lg flex justify-between items-center">
                    Manage Asset Classes (Available based on selected sources)
                    <span class="text-gray-500">â–¼</span>
                </summary>
                <div id="assetSelectionCheckboxes" class="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-y-2 gap-x-4">
                    <!-- Asset Checkboxes will be dynamically generated here -->
                </div>
            </details>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6">
                <div id="calculator-inputs">
                    <!-- Sliders will be dynamically generated here -->
                </div>

                <div class="flex flex-col items-center justify-center bg-gray-50 rounded-lg p-6">
                    <p id="totalAllocation" class="text-lg font-bold text-green-600 mb-4">Total Allocation: 0%</p>
                    <div class="text-center mb-6">
                        <p class="text-lg font-semibold text-gray-700">Projected 10+ Year Nominal Return</p>
                        <p id="projectedReturn10Plus" class="text-5xl font-extrabold kpi-endowment">0.0%</p>
                    </div>
                    <!-- New chart for allocation visualization -->
                    <div class="chart-container h-60 mt-6">
                        <canvas id="allocationChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
     
        <section id="endowment-implementation" class="max-w-7xl mx-auto bg-white rounded-lg shadow-md p-6 md:p-8 mb-12">
            <h2 class="text-3xl font-bold text-center section-title mb-8">Actionable Strategy: Implementing Endowment Changes</h2>
            <p class="text-center text-gray-700 max-w-4xl mx-auto mb-10">Effectively combating the demographic cliff and adapting to new market realities requires a clear implementation path. Proactive steps in governance, expertise, and pacing are key to unlocking higher returns amidst the evolving landscape of AI-enabled productivity, energy transition, and globalization shifts, as well as evolving policy and regulatory paradigms.</p>
            <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4">
                <div class="text-center p-4 flowchart-step rounded-lg w-full md:w-1/4">
                    <p class="text-4xl">1</p><h3 class="font-bold text-lg mt-2">Strengthen Governance</h3>
                    <p class="text-sm">Establish a clear Investment Policy Statement (IPS) to support a more diversified, growth-oriented strategy.</p>
                </div>
                <div class="flowchart-arrow transform md:rotate-0 rotate-90">&rarr;</div>
                <div class="text-center p-4 flowchart-step rounded-lg w-full md:w-1/4">
                    <p class="text-4xl">2</p><h3 class="font-bold text-lg mt-2">Engage Expertise</h3>
                    <p class="text-sm">Leverage an Outsourced CIO (OCIO) or specialized consultants to access top-tier private managers and global expertise.</p>
                </div>
                <div class="flowchart-arrow transform md:rotate-0 rotate-90">&rarr;</div>
                <div class="text-center p-4 flowchart-step rounded-lg w-full md:w-1/4">
                    <p class="text-4xl">3</p><h3 class="font-bold text-lg mt-2">Pace Commitments</h3>
                    <p class="text-sm">Build private market exposure gradually over multiple years to manage cash flow and the J-curve effect.</p>
                </div>
                <div class="flowchart-arrow transform md:rotate-0 rotate-90">&rarr;</div>
                <div class="text-center p-4 flowchart-step rounded-lg w-full md:w-1/4">
                    <p class="text-4xl">4</p><h3 class="font-bold text-lg mt-2">Monitor & Adapt</h3>
                    <p class="text-sm">Conduct regular portfolio reviews to adapt to changing market conditions and ensure alignment with long-term goals.</p>
                </div>
            </div>
        </section>

    </main>

    <footer class="text-center p-6 mt-12 bg-gray-800 text-white">
        <p>This infographic synthesizes data for strategic planning purposes.</p>
        <p class="text-sm text-gray-400 mt-2">Demographic data from Western Interstate Commission for Higher Education (WICHE). Financial forecasts are based on Northern Trust's Capital Market Assumptions 10-Year Outlook: 2025 Edition, released January 2025, with supplementary data from other leading financial institutions' Spring 2025 outlooks.</p>
    </footer>

    <script>
        // Palette from "colour combinations" focusing on vibrant blues and accents
        const chartColors = {
            blue1: '#003B6D',
            blue2: '#00529B',
            blue3: '#70C4FF',
            accentGold: '#FFBC42',
            accentRed: '#D62828',
            gray: '#E5E7EB'
        };

        const FONT_COLOR = '#1F2937';
        Chart.defaults.color = FONT_COLOR;
        Chart.defaults.font.family = "'Inter', sans-serif";

        const wrapLabel = (label, maxWidth = 16) => {
            if (typeof label !== 'string') return label;
            const words = label.split(' ');
            let lines = [];
            let currentLine = '';
            words.forEach(word => {
                if ((currentLine + ' ' + word).trim().length > maxWidth && currentLine !== '') {
                    lines.push(currentLine.trim());
                    currentLine = word;
                } else {
                    currentLine = (currentLine + ' ' + word).trim();
                }
            });
            if (currentLine) lines.push(currentLine.trim());
            return lines;
        };

        const tooltipTitleCallback = (tooltipItems) => {
            const item = tooltipItems[0];
            let label = item.chart.data.labels[item.dataIndex];
            if (Array.isArray(label)) return label.join(' ');
            return label;
        };

        const commonPlugins = {
            legend: {
                position: 'bottom',
                labels: { color: FONT_COLOR, font: { weight: '600' } }
            },
            tooltip: {
                enabled: true,
                mode: 'index',
                intersect: false,
                callbacks: { title: tooltipTitleCallback },
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleFont: { size: 14, weight: 'bold' },
                bodyFont: { size: 12 },
            }
        };

        const defaultChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: commonPlugins,
            scales: {
                y: { beginAtZero: false, grid: { color: '#E0E0E0' }, ticks: { font: { size: 12 } } },
                x: { grid: { display: false }, ticks: { font: { size: 12 } } }
            }
        };

        new Chart(document.getElementById('nationalDeclineChart'), {
            type: 'line',
            data: {
                labels: ['2025', '2027', '2029', '2031', '2033', '2035', '2037', '2039', '2041'],
                datasets: [{
                    label: 'Projected HS Graduates (Indexed)',
                    data: [100, 97, 92, 89, 88, 88, 87, 86.5, 87],
                    borderColor: chartColors.accentRed,
                    backgroundColor: 'rgba(214, 40, 40, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: { ...defaultChartOptions, scales: { y: { ...defaultChartOptions.scales.y, title: { display: true, text: 'Index (2025 = 100)' } } } }
        });

        const regionalData = [
            { state: 'Ohio', decline: -6 },
            { state: 'Kentucky', decline: -9 },
            { state: 'Indiana', decline: -10 },
            { state: 'Pennsylvania', decline: -17 },
            { state: 'Michigan', decline: -20 },
            { state: 'West Virginia', decline: -26 },
        ].sort((a, b) => a.decline - b.decline);

        new Chart(document.getElementById('regionalDeclineChart'), {
            type: 'bar',
            data: {
                labels: regionalData.map(d => wrapLabel(d.state, 12)),
                datasets: [{
                    label: 'Projected % Change in HS Grads (2023-2041)',
                    data: regionalData.map(d => d.decline),
                    backgroundColor: chartColors.blue2,
                    borderColor: chartColors.blue1,
                    borderWidth: 1
                }]
            },
            options: { ...defaultChartOptions, indexAxis: 'y', scales: { x: { title: { display: true, text: 'Percent Change (%)' } } } }
        });

        new Chart(document.getElementById('ohioCollegeRateChart'), {
            type: 'doughnut',
            data: {
                labels: ['2010: Enrolled', '2010: Not Enrolled', '2023: Enrolled', '2023: Not Enrolled'],
                datasets: [{
                    label: '2010 Rate',
                    data: [72, 28, 0, 0],
                    backgroundColor: [chartColors.blue2, chartColors.gray],
                    circumference: 180,
                    rotation: -90
                }, {
                    label: '2023 Rate',
                    data: [0, 0, 66, 34],
                    backgroundColor: [chartColors.accentRed, chartColors.gray],
                    circumference: 180,
                    rotation: -90
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'Ohio College-Going Rate', font: { size: 16, weight: 'bold' } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.dataIndex > 1) { // 2023 data
                                    return `2023 ${context.label.split(':')[1]}: ${context.parsed}%`;
                                }
                                return `2010 ${context.label.split(':')[1]}: ${context.parsed}%`;
                            },
                            title: () => ''
                        }
                    }
                },
                cutout: '60%'
            }
        });

        new Chart(document.getElementById('allocationBySizeChart'), {
            type: 'bar',
            data: {
                labels: ['<$50M', '$51-100M', wrapLabel('$101-250M'), wrapLabel('$251-500M'), '$501M-1B', '$1B-5B', '>$5B'],
                datasets: [
                    { label: 'Public Equities', data: [59.6, 58.0, 51.6, 47.0, 43.3, 37.0, 24.2], backgroundColor: chartColors.blue2 },
                    { label: 'Fixed Income', data: [26.1, 23.9, 20.1, 16.2, 15.9, 12.0, 7.6], backgroundColor: chartColors.blue3 },
                    { label: 'Alternatives', data: [8.6, 11.6, 20.1, 27.0, 31.2, 40.2, 52.0], backgroundColor: chartColors.accentGold },
                    { label: 'Real Assets', data: [4.9, 5.1, 6.4, 7.3, 7.5, 9.0, 12.5], backgroundColor: chartColors.accentRed },
                ]
            },
            options: { ...defaultChartOptions, scales: { x: { stacked: true }, y: { stacked: true, title: { display: true, text: 'Allocation (%)' } } } }
        });
     
        const ntExpectedReturnsChartData = {
            labels: [
                wrapLabel('U.S. Inflation Linked (TIPS)'),
                wrapLabel('U.S. Aggregate Fixed Income'),
                wrapLabel('Hedge Funds'),
                wrapLabel('Listed Real Estate'),
                wrapLabel('Emerging Markets Equities'),
                wrapLabel('Global Equities'),
                wrapLabel('U.S. Equities'),
                wrapLabel('Private Real Estate'),
                wrapLabel('Private Credit'),
                wrapLabel('Opportunistic Private Credit'),
                wrapLabel('Private Equity')
            ],
            returns: [4.0, 4.7, 5.5, 6.3, 6.4, 7.1, 7.5, 7.3, 8.4, 12.2, 10.1]
        };
        ntExpectedReturnsChartData.labels.sort((a, b) => {
            const indexA = ntExpectedReturnsChartData.labels.indexOf(a);
            const indexB = ntExpectedReturnsChartData.labels.indexOf(b);
            return ntExpectedReturnsChartData.returns[indexA] - ntExpectedReturnsChartData.returns[indexB];
        });
        ntExpectedReturnsChartData.returns.sort((a, b) => a - b);


        new Chart(document.getElementById('expectedReturnsChart'), {
            type: 'bar',
            data: {
                labels: ntExpectedReturnsChartData.labels,
                datasets: [{
                    label: 'Northern Trust 10-Year Nominal Return (%)',
                    data: ntExpectedReturnsChartData.returns,
                    backgroundColor: chartColors.blue1
                }]
            },
            options: { ...defaultChartOptions, indexAxis: 'y', scales: { x: { title: { display: true, text: 'Annualized Nominal Return (%)' } } } }
        });
     
        // Embedded Python generated JSON data directly as JavaScript objects
        const allAssetReturns = {
            "Northern Trust": {
                "US Large Cap Equities":    7.5,
                "US Small Cap Equities":	9.6,
                "Developed International Equities (General)":	7.1,
                "Emerging Market Equities":	6.4,
                "Global Equities (ACWI)":7.1,
                "Global Developed Equities":	7.1,
                "US Investment Grade Bonds":	4.7,
                "US High Yield Bonds":	5.6,
                "US TIPS":	4.0,
                "Cash Equivalents / US Cash":	3.3,
                "Real Estate (REITs)":	6.3,
                "Commodities":	6.2,
                "Private Equity":	10.1,
                "Private Debt / Private Credit":	8.4,
                "Hedge Funds":	5.5,
                "Global Investment Grade Bonds":	3.6,
                "Global High Yield Bonds":	5.9,
                "Global Natural Resources":	6.2,
                "Global Listed Infrastructure":	6.6,
                "Australian Equities":	8.2,
                "Canadian Equities":	5.3,
                "Europe Equities":	5.2,
                "UK Equities":	4.4,
                "Japan Equities":	6.0,
                "Canadian Bonds (Aggregate/Universe)":	3.6,
                "Euro Government Bonds":	3.1,
                "Euro Corporate Bonds":	3.1,
                "Australian Government Bonds":	4.5,
                "Japanese Government Bonds":	1.4,
                "UK Government Bonds":	4.9,
                "Venture Capital":	11.6,
                "Buyout":	9.5,
                "Growth (Private Equity)":	11.0,
                "Inflation Linked (Canada)":	2.5,
                "Inflation Linked (Euro)":	3.0,
                "Inflation Linked (UK)":	3.2,
                "Inflation Linked (Japan)":	1.5,
                "Inflation Linked (Australia)":	4.2,
                "Inflation Linked (Global)":	3.3,
                "Municipal Bonds":	4.0,
                "HF-Equity Hedge":	5.4,
                "HF-Relative Value":	5.6,
                "HF-Macro":	6.0,
                "HF-Event Driven":	5.1
            },
            "Janney Montgomery Scott": {
                "US Large Cap Equities":	7.0,
                "US Small Cap Equities":	8.5,
                "Developed International Equities (General)":	8.0,
                "Emerging Market Equities":	8.5,
                "US Investment Grade Bonds":	5.25,
                "US High Yield Bonds":	6.5,
                "Cash Equivalents / US Cash":	3.2,
                "Real Estate (REITs)":	7.0,
                "Commodities":	5.0,
                "Private Equity":	9.0,
                "Private Debt / Private Credit":	6.75

            },
            "State Street Global Advisors": {
                "US Large Cap Equities":	6.1,
                "US Small Cap Equities":6.6,
                "US Mid Cap Equities":	6.3,
                "Developed International Equities (General)":	6.6,
                "Developed International Small Cap Equities":	7.4,
                "Emerging Market Equities":	7.3,
                "Global Equities (ACWI)":	6.3,
                "Global Developed Equities":	6.2,
                "US Investment Grade Bonds":	4.8,
                "US High Yield Bonds":	5.4,
                "US TIPS":	4.2,
                "US Government Bonds":	4.5,
                "US Long Treasury STRIPS Bond":	6.0,
                "Cash Equivalents / US Cash	":3.1,
                "Real Estate (REITs)":	5.7,
                "Commodities":	5.0,
                "Private Equity":7.9,
                "Hedge Funds":4.8,
                "Global Investment Grade Bonds":	4.2,
                "Developed Pacific Equities":	5.5,
                "Australian Equities":	7.4,
                "New Zealand Equities":	4.6,
                "Canadian Equities":	6.5,
                "Europe Equities":	7.3,
                "Euro Equities":	7.1,
                "Canadian Bonds (Aggregate/Universe)":	3.2,
                "Canadian Government Bonds":	3.0,
                "Canadian Corporate Bonds":3.6,
                "Non-US Government Bonds":	2.5,
                "Non-US Corporate Bonds":	3.3,
                "Euro Government Bonds":	2.8,
                "Euro Corporate Bonds":	2.8,
                "Australian Government Bonds":	4.3,
                "Australian Corporate Bonds":	4.7,
                "New Zealand Government Bonds":	4.0,
                "Japanese Government Bonds":	1.3,
                "Japanese Corporate Bonds":	1.,
                "UK Government Bonds":	5.1,
                "UK Corporate Bonds":	5.2,
                "Emerging Markets Bonds":	7.7,
                "Core Private Credit":	6.9,
                "Opportunistic Private Credit":	12.2,
                "Direct Real Estate - US":	8.3,
                "UK Cash":	2.9,
                "EMU Cash":	1.9,
                "Canada Cash":	2.5,
                "Australia Cash":	2.6,
                "New Zealand Cash":	3.1,
                "Global Value Tilted Equities":	6.0,
                "Global Quality Tilted Equities":	6.4,
                "Global Momentum Tilted Equities":	7.3,
                "Global Minimum Variance Equities":	6.6,
                "EM Asia Equities":	6.7,
                "EM EMEA Equities":	8.9,
                "EM Latin America Equities":	13.5

            },
            "Vanguard": {
                "US Large Cap Equities": 5.3,
                "Developed International Equities (General)": 7.6,
                "Emerging Markets Equities (General)": 4.7
            },
            "Charles Schwab": {
                "US Large Cap Equities": 6.0,
                "US Small Cap Equities": 6.2,
                "Developed International Equities (General)": 7.1,
                "Developed International Small Cap Equities": 8.1,
                "Emerging Market Equities": 7.0,
                "US Investment Grade Bonds": 4.9,
                "US TIPS": 4.2,
                "Cash (3-Month T-Bill)": 3.5
            }
        };
        
        // Defines the categories for each asset class to facilitate sorting and grouping.
        // The categories are ordered for display purposes.
        const assetCategories = {
            "Equities": [
                "US Large Cap Equities", "US Small Cap Equities", "US Mid Cap Equities",
                "Developed International Equities (General)", "Developed International Small Cap Equities",
                "Emerging Market Equities", "Emerging Markets Equities (General)", "Global Equities (ACWI)",
                "Global Developed Equities", "Australian Equities", "Canadian Equities", "Europe Equities",
                "UK Equities", "Japan Equities", "New Zealand Equities", "Developed Pacific Equities",
                "Euro Equities", "Global Value Tilted Equities", "Global Quality Tilted Equities",
                "Global Momentum Tilted Equities", "Global Minimum Variance Equities", "EM Asia Equities",
                "EM EMEA Equities", "EM Latin America Equities"
            ],
            "Fixed Income": [
                "US Investment Grade Bonds", "US High Yield Bonds", "US TIPS", "US Government Bonds",
                "US Long Treasury STRIPS Bond", "Global Investment Grade Bonds", "Global High Yield Bonds",
                "Canadian Bonds (Aggregate/Universe)", "Canadian Government Bonds", "Canadian Corporate Bonds",
                "Euro Government Bonds", "Euro Corporate Bonds", "Australian Government Bonds",
                "Australian Corporate Bonds", "New Zealand Government Bonds", "Japanese Government Bonds",
                "Japanese Corporate Bonds", "UK Government Bonds", "UK Corporate Bonds",
                "Emerging Markets Bonds", "Non-US Government Bonds", "Non-US Corporate Bonds",
                "Municipal Bonds", "Inflation Linked (Canada)", "Inflation Linked (Euro)",
                "Inflation Linked (UK)", "Inflation Linked (Japan)", "Inflation Linked (Australia)",
                "Inflation Linked (Global)"
            ],
            "Alternatives & Private Markets": [
                "Private Equity", "Private Debt / Private Credit", "Hedge Funds",
                "Opportunistic Private Credit", "Venture Capital", "Buyout", "Growth (Private Equity)",
                "HF-Equity Hedge", "HF-Relative Value", "HF-Macro", "HF-Event Driven", "Core Private Credit"
            ],
            "Real Assets": [
                "Real Estate (REITs)", "Commodities", "Global Natural Resources",
                "Global Listed Infrastructure", "Direct Real Estate - US"
            ],
            "Cash & Equivalents": [
                "Cash Equivalents / US Cash", "Cash (3-Month T-Bill)", "UK Cash", "EMU Cash", "Canada Cash",
                "Australia Cash", "New Zealand Cash"
            ]
        };

        // Helper function to determine the broad category of an asset.
        function getAssetCategory(assetName) {
            for (const category in assetCategories) {
                if (assetCategories[category].includes(assetName)) {
                    return category;
                }
            }
            return "Other"; // Fallback for any unlisted asset classes
        }

        // Defines the order in which asset categories should appear.
        const categoryOrder = [
            "Equities",
            "Fixed Income",
            "Alternatives & Private Markets",
            "Real Assets",
            "Cash & Equivalents",
            "Other" // Ensure "Other" is always last
        ];

        const sourceCheckboxesDiv = document.getElementById('sourceCheckboxes');
        const calculatorInputsDiv = document.getElementById('calculator-inputs');
        const totalAllocationEl = document.getElementById('totalAllocation');
        const projectedReturn10PlusEl = document.getElementById('projectedReturn10Plus');
        const assetSelectionCheckboxesDiv = document.getElementById('assetSelectionCheckboxes');
        const assetSelectionDetails = document.getElementById('assetSelectionDetails');

        let currentSliders = {};
        let currentValuesDisplays = {};
        let allPossibleAssetClasses = new Set();
        let selectedSources = new Set();
        let selectedAssetClasses = new Set();

        let savedSliderValues = {}; 
        let allocationChart; // Global variable for the new allocation chart

        // A comprehensive color palette for the doughnut chart, ensuring variety
        const allocationChartColors = [
            '#003B6D', '#00529B', '#70C4FF', '#FFBC42', '#D62828', '#8B4513', '#228B22', '#4682B4', '#DAA520', '#CD5C5C',
            '#6A5ACD', '#FF6347', '#48D1CC', '#9932CC', '#8B0000', '#2E8B57', '#BDB76B', '#5F9EA0', '#FF8C00', '#BA55D3'
        ];


        const defaultSafeAssets = [
            'US Aggregate Fixed Income', 
            'US Large Cap Equities', 
            'Hedge Funds', 
            'Listed Real Estate', 
            'US Inflation Linked (TIPS)'
        ];

        function populateAllPossibleAssetClasses() {
            for (const sourceName in allAssetReturns) {
                for (const assetClass in allAssetReturns[sourceName]) {
                    allPossibleAssetClasses.add(assetClass);
                }
            }
        }

        function renderSourceCheckboxes() {
            sourceCheckboxesDiv.innerHTML = '';

            const sortedSourceNames = Object.keys(allAssetReturns).sort();
            sortedSourceNames.forEach(sourceName => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.classList.add('flex', 'items-center');

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `source-${sourceName.replace(/[^a-zA-Z0-9]/g, '')}`;
                input.value = sourceName;
                input.classList.add('h-4', 'w-4', 'text-blue-600', 'border-gray-300', 'rounded', 'focus:ring-2', 'focus:ring-blue-500');
                input.addEventListener('change', handleSourceChange);

                // Check if this source is already selected when rendering
                if (selectedSources.has(sourceName)) {
                    input.checked = true;
                }

                const label = document.createElement('label');
                label.setAttribute('for', `source-${sourceName.replace(/[^a-zA-Z0-9]/g, '')}`);
                label.classList.add('ml-2', 'text-sm', 'font-medium', 'text-gray-900');
                label.textContent = sourceName;

                checkboxDiv.appendChild(input);
                checkboxDiv.appendChild(label);
                sourceCheckboxesDiv.appendChild(checkboxDiv);
            });
        }

        function handleSourceChange(event) {
            const sourceName = event.target.value;
            if (event.target.checked) {
                selectedSources.add(sourceName);
            } else {
                selectedSources.delete(sourceName);
            }
            updateCalculatorDisplay();
        }

        function getExpectedReturnsForSelectedSources() {
            const combinedReturns = {};
            const assetSourceCounts = {};

            if (selectedSources.size === 0) {
                return {};
            }

            selectedSources.forEach(sourceName => {
                const sourceData = allAssetReturns[sourceName];
                for (const assetClass in sourceData) {
                    if (sourceData[assetClass] !== undefined && sourceData[assetClass] !== null) {
                        if (!combinedReturns[assetClass]) {
                            combinedReturns[assetClass] = 0;
                            assetSourceCounts[assetClass] = 0;
                        }
                        combinedReturns[assetClass] += sourceData[assetClass];
                        assetSourceCounts[assetClass]++;
                    }
                }
            });

            const averagedReturns = {};
            for (const assetClass in combinedReturns) {
                if (assetSourceCounts[assetClass] > 0) {
                    averagedReturns[assetClass] = combinedReturns[assetClass] / assetSourceCounts[assetClass];
                }
            }
            return averagedReturns;
        }


        function renderAssetSelectionCheckboxes() {
            assetSelectionCheckboxesDiv.innerHTML = '';
            
            const currentAvailableAssets = getExpectedReturnsForSelectedSources();
            
            // Convert available assets into an array for custom sorting
            let assetsToSort = Object.keys(currentAvailableAssets).map(assetName => ({
                name: assetName,
                return: currentAvailableAssets[assetName],
                category: getAssetCategory(assetName)
            }));

            // Custom sort function:
            // 1. Sort by category order (e.g., Equities before Fixed Income)
            // 2. Then, within each category, sort by return (descending)
            // 3. Finally, by asset name alphabetically as a tie-breaker
            assetsToSort.sort((a, b) => {
                const categoryCompare = categoryOrder.indexOf(a.category) - categoryOrder.indexOf(b.category);
                if (categoryCompare !== 0) {
                    return categoryCompare;
                }
                const returnCompare = b.return - a.return; // Descending return
                if (returnCompare !== 0) {
                    return returnCompare;
                }
                return a.name.localeCompare(b.name); // Alphabetical by name
            });
            
            // Clear selectedAssetClasses and repopulate based on what's available and previously saved
            const newSelectedAssetClasses = new Set(); 

            if (assetsToSort.length === 0) {
                assetSelectionCheckboxesDiv.innerHTML = '<p class="text-gray-500">No asset classes available for the selected source(s).</p>';
                selectedAssetClasses = newSelectedAssetClasses;
                return;
            }

            assetsToSort.forEach(asset => {
                const assetClass = asset.name;
                const expectedReturn = asset.return;
                const assetCategory = asset.category;

                // Create a div for the category header if it's a new category
                if (!document.getElementById(`category-header-${assetCategory.replace(/[^a-zA-Z0-9]/g, '')}`)) {
                    const categoryHeader = document.createElement('h4');
                    categoryHeader.id = `category-header-${assetCategory.replace(/[^a-zA-Z0-9]/g, '')}`;
                    categoryHeader.classList.add('col-span-full', 'text-md', 'font-semibold', 'text-gray-700', 'mt-4', 'mb-2');
                    categoryHeader.textContent = assetCategory;
                    assetSelectionCheckboxesDiv.appendChild(categoryHeader);
                }

                const checkboxDiv = document.createElement('div');
                checkboxDiv.classList.add('flex', 'items-center');

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `checkbox-${assetClass.replace(/[^a-zA-Z0-9]/g, '')}`;
                input.value = assetClass;
                input.classList.add('h-4', 'w-4', 'text-blue-600', 'border-gray-300', 'rounded', 'focus:ring-2', 'focus:ring-blue-500');
                
                // Determine if checkbox should be checked
                let shouldBeChecked = false;
                // If only Northern Trust is selected initially, select default safe assets
                // This condition now applies only if NO other sources are selected AND it's a default safe asset
                if (selectedSources.has('Northern Trust') && selectedSources.size === 1 && defaultSafeAssets.includes(assetClass)) {
                    shouldBeChecked = true;
                } 
                // If the asset was previously selected AND is still available in current source(s)
                else if (selectedAssetClasses.has(assetClass) && currentAvailableAssets[assetClass] !== undefined) {
                    shouldBeChecked = true;
                } 
                // If the asset had a saved slider value greater than 0 AND is still available
                else if (savedSliderValues[assetClass] !== undefined && parseFloat(savedSliderValues[assetClass]) > 0 && currentAvailableAssets[assetClass] !== undefined) {
                    shouldBeChecked = true;
                }

                if (shouldBeChecked) {
                    input.checked = true;
                    newSelectedAssetClasses.add(assetClass);
                } else {
                    input.checked = false;
                }

                input.addEventListener('change', (event) => {
                    if (event.target.checked) {
                        selectedAssetClasses.add(assetClass);
                    } else {
                        selectedAssetClasses.delete(assetClass);
                        savedSliderValues[assetClass] = '0';
                    }
                    renderSliders(); 
                    calculateReturns(); 
                });

                const label = document.createElement('label');
                label.setAttribute('for', `checkbox-${assetClass.replace(/[^a-zA-Z0-9]/g, '')}`);
                label.classList.add('ml-2', 'text-sm', 'font-medium', 'text-gray-900');
                
                const expectedReturnText = expectedReturn !== undefined ? ` (${expectedReturn.toFixed(1)}% Exp.)` : '';
                label.textContent = `${assetClass}${expectedReturnText}`;

                checkboxDiv.appendChild(input);
                checkboxDiv.appendChild(label);
                assetSelectionCheckboxesDiv.appendChild(checkboxDiv);
            });
            selectedAssetClasses = newSelectedAssetClasses;
        }

        function renderSliders() {
            // Save current slider values before clearing
            for (const assetClass in currentSliders) {
                savedSliderValues[assetClass] = currentSliders[assetClass].value;
            }

            calculatorInputsDiv.innerHTML = ''; 
            currentSliders = {};
            currentValuesDisplays = {};

            const currentExpectedReturns = getExpectedReturnsForSelectedSources();
            
            // Get selected asset classes, include their returns and categories for sorting
            let selectedAssetsForSliders = Array.from(selectedAssetClasses).map(assetName => ({
                name: assetName,
                return: currentExpectedReturns[assetName],
                category: getAssetCategory(assetName)
            })).filter(asset => asset.return !== undefined && asset.return !== null); // Filter out assets with no return data

            // Sort these assets using the same logic as for checkboxes
            selectedAssetsForSliders.sort((a, b) => {
                const categoryCompare = categoryOrder.indexOf(a.category) - categoryOrder.indexOf(b.category);
                if (categoryCompare !== 0) {
                    return categoryCompare;
                }
                const returnCompare = b.return - a.return;
                if (returnCompare !== 0) {
                    return returnCompare;
                }
                return a.name.localeCompare(b.name);
            });

            if (selectedAssetsForSliders.length === 0) {
                 calculatorInputsDiv.innerHTML = '<p class="text-gray-500">Please select asset classes above to view and adjust allocations.</p>';
            }

            selectedAssetsForSliders.forEach(asset => {
                const assetClass = asset.name;
                const expectedReturn = asset.return;
                const assetCategory = asset.category;

                // Add category header for sliders as well
                if (!document.getElementById(`slider-category-header-${assetCategory.replace(/[^a-zA-Z0-9]/g, '')}`)) {
                    const categoryHeader = document.createElement('h4');
                    categoryHeader.id = `slider-category-header-${assetCategory.replace(/[^a-zA-Z0-9]/g, '')}`;
                    categoryHeader.classList.add('col-span-full', 'text-md', 'font-semibold', 'text-gray-700', 'mt-4', 'mb-2');
                    categoryHeader.textContent = assetCategory;
                    calculatorInputsDiv.appendChild(categoryHeader);
                }

                const inputGroup = document.createElement('div');
                inputGroup.classList.add('asset-input-group');

                const label = document.createElement('label');
                label.setAttribute('for', `${assetClass.replace(/[^a-zA-Z0-9]/g, '')}Slider`);
                label.innerHTML = `${assetClass}: <span class="value-display" id="${assetClass.replace(/[^a-zA-Z0-9]/g, '')}ExpectedReturn">${expectedReturn.toFixed(1)}%</span> Expected`;
                   
                const sliderLabel = document.createElement('span');
                sliderLabel.textContent = ` Allocation: `;
                label.appendChild(sliderLabel);

                const sliderValueDisplay = document.createElement('span');
                sliderValueDisplay.id = `${assetClass.replace(/[^a-zA-Z0-9]/g, '')}Value`;
                sliderValueDisplay.textContent = '0%'; 
                sliderLabel.appendChild(sliderValueDisplay);

                const slider = document.createElement('input');
                slider.type = 'range';
                slider.id = `${assetClass.replace(/[^a-zA-Z0-9]/g, '')}Slider`;
                slider.min = '0';
                slider.max = '100';
                slider.value = savedSliderValues[assetClass] !== undefined ? savedSliderValues[assetClass] : '0';
                slider.classList.add('w-full', 'h-2', 'bg-gray-200', 'rounded-lg', 'appearance-none', 'cursor-pointer', 'calculator-slider');
                slider.addEventListener('input', calculateReturns);

                inputGroup.appendChild(label);
                inputGroup.appendChild(slider);
                calculatorInputsDiv.appendChild(inputGroup);

                currentSliders[assetClass] = slider;
                currentValuesDisplays[assetClass] = sliderValueDisplay;
            });
        }

        function calculateReturns() {
            const currentExpectedReturns = getExpectedReturnsForSelectedSources();

            let totalPercent = 0;
            let calculatedReturn = 0;
            const chartLabels = [];
            const chartData = [];
            const chartBackgroundColors = [];
            let colorIndex = 0;

            for (const assetClass in currentSliders) {
                const percent = parseFloat(currentSliders[assetClass].value);
                totalPercent += percent;
                currentValuesDisplays[assetClass].textContent = `${percent.toFixed(0)}%`;

                if (currentExpectedReturns[assetClass] !== undefined && currentExpectedReturns[assetClass] !== null) {
                    calculatedReturn += (percent / 100) * currentExpectedReturns[assetClass];
                }

                // Add data for chart only if allocation is greater than 0
                if (percent > 0) {
                    chartLabels.push(assetClass);
                    chartData.push(percent);
                    chartBackgroundColors.push(allocationChartColors[colorIndex % allocationChartColors.length]);
                    colorIndex++;
                }
            }

            totalAllocationEl.textContent = `Total Allocation: ${totalPercent.toFixed(0)}%`;
            if (Math.round(totalPercent) !== 100) {
                totalAllocationEl.classList.remove('text-green-600');
                totalAllocationEl.classList.add('text-red-600');
            } else {
                totalAllocationEl.classList.remove('text-red-600');
                totalAllocationEl.classList.add('text-green-600');
            }
           
            projectedReturn10PlusEl.textContent = `${calculatedReturn.toFixed(1)}%`;

            // Update the allocation chart
            if (allocationChart) {
                allocationChart.data.labels = chartLabels;
                allocationChart.data.datasets[0].data = chartData;
                allocationChart.data.datasets[0].backgroundColor = chartBackgroundColors;
                allocationChart.update();
            }
        }

        function updateCalculatorDisplay() {
            renderAssetSelectionCheckboxes();
            renderSliders();
            calculateReturns();
        }


        // Initial setup on window load
        window.onload = function() {
            populateAllPossibleAssetClasses();
            
            // Define the default portfolio allocations
            const defaultPortfolio = {
                "US Small Cap Equities": 15,
                "US Large Cap Equities": 15,
                "US Investment Grade Bonds": 5,
                "Venture Capital": 25,
                "Growth (Private Equity)": 20,
                "Hedge Funds": 5,
                "Real Estate (REITs)": 10,
                "Cash Equivalents / US Cash": 5
            };

            // Set Northern Trust as initially selected source and pre-set default portfolio
            selectedSources.add('Northern Trust');
            for (const asset in defaultPortfolio) {
                savedSliderValues[asset] = defaultPortfolio[asset].toString();
                selectedAssetClasses.add(asset);
            }

            // Now render the source checkboxes, which will now correctly show Northern Trust as checked
            renderSourceCheckboxes(); 

            // Initialize the allocation chart
            const ctx = document.getElementById('allocationChart').getContext('2d');
            allocationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [], // Will be populated dynamically
                    datasets: [{
                        data: [], // Will be populated dynamically
                        backgroundColor: [], // Will be populated dynamically
                        borderWidth: 1,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 10, // Smaller font for legend labels
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Current Portfolio Allocation',
                            font: {
                                size: 14, // Smaller font for chart title
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    cutout: '60%', // Makes it a doughnut chart
                }
            });

            // Initial render and calculation
            updateCalculatorDisplay();

            // Add an event listener to the <details> element to check its open state
            const assetSelectionDetailsElement = document.getElementById('assetSelectionDetails');
            assetSelectionDetailsElement.addEventListener('toggle', () => {
                if (!assetSelectionDetailsElement.open) {
                    updateCalculatorDisplay();
                }
            });
        };

    </script>
</body>
</html>
